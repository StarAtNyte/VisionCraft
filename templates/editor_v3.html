<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Make3D Studio</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: '#8b5cf6', // Vibrant purple
            "background-light": "#0f172a", // Deep dark blue-gray
            "background-dark": "#0f172a", // Deep dark blue-gray
            "surface-light": "#1e293b", // Darker slate for surfaces
            "surface-dark": "#1e293b", // Darker slate for surfaces
            "text-light": "#e2e8f0", // Light gray for text
            "text-dark": "#e2e8f0", // Light gray for text
            "subtle-light": "#94a3b8", // Muted blue-gray for subtle text
            "subtle-dark": "#94a3b8", // Muted blue-gray for subtle text
            "accent-blue": "#2563eb", // Bright blue
            "accent-green": "#10b981" // Bright green
          },
          fontFamily: {
            sans: ["Roboto", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "0.5rem",
          },
        },
      },
    };
</script>
<style>
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-smoothing: antialiased;
    }
    .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.75rem;
    }
    .tool-card {
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    .tool-card:hover {
        background: rgba(139, 92, 246, 0.1);
        border-color: #8b5cf6;
        transform: translateY(-1px);
    }
    .upload-area {
        border: 2px dashed #374151;
        transition: all 0.3s ease;
    }
    .upload-area:hover {
        border-color: #8b5cf6;
        background-color: rgba(139, 92, 246, 0.05);
    }
    .upload-area.dragover {
        border-color: #8b5cf6;
        background-color: rgba(139, 92, 246, 0.1);
    }
    .range-slider {
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        border-radius: 3px;
        background: rgba(55, 65, 81, 0.8);
        outline: none;
        cursor: pointer;
    }
    .range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #8b5cf6;
        cursor: pointer;
    }
    .range-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #8b5cf6;
        cursor: pointer;
        border: none;
    }
</style>
</head>
<body class="bg-background-light text-text-light font-sans">
<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-[300px] bg-surface-light flex flex-col p-4 border-r border-gray-800">
        <div class="mb-6">
            <h2 class="text-lg font-bold text-text-light">Make3D Studio</h2>
        </div>
        
        <!-- Navigation -->
        <nav class="flex flex-col space-y-2 mb-6">
            <a class="flex items-center p-2 rounded-lg bg-primary text-white" href="#">
                <span class="material-icons">dashboard</span>
                <span class="ml-3">Dashboard</span>
            </a>
            <a class="flex items-center p-2 rounded-lg hover:bg-gray-800" href="#">
                <span class="material-icons">folder</span>
                <span class="ml-3">Projects</span>
            </a>
            <a class="flex items-center p-2 rounded-lg hover:bg-gray-800" href="#">
                <span class="material-icons">photo_library</span>
                <span class="ml-3">Gallery</span>
            </a>
            <a class="flex items-center p-2 rounded-lg hover:bg-gray-800" href="#">
                <span class="material-icons">price_change</span>
                <span class="ml-3">Pricing</span>
            </a>
            <a class="flex items-center p-2 rounded-lg hover:bg-gray-800" href="#">
                <span class="material-icons">account_circle</span>
                <span class="ml-3">Account</span>
            </a>
        </nav>

        <!-- Content Creation Phase -->
        <div id="creation-phase" class="flex-1 overflow-y-auto">
            <div class="mb-4">
                <h3 class="font-semibold text-sm mb-2 text-subtle-light">Phase 1: Content Creation</h3>
            </div>
            
            <!-- AI Generation Section -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-2">AI Generation</h4>
                <div class="p-4 bg-gray-800 rounded-lg">
                    <textarea 
                        id="ai-prompt" 
                        class="w-full bg-surface-light border border-gray-700 rounded-md p-2 text-sm focus:ring-primary focus:border-primary resize-none" 
                        placeholder="Describe your product..." 
                        rows="3">
                    </textarea>
                    <div class="flex items-center justify-between mt-2 text-sm">
                        <button class="flex items-center text-subtle-light hover:text-primary">
                            Advanced Settings <span class="material-icons text-base">expand_more</span>
                        </button>
                        <button class="flex items-center text-subtle-light hover:text-primary">
                            Style Presets <span class="material-icons text-base">expand_more</span>
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="generateWithAI()" class="bg-primary text-white py-2 rounded-md text-sm font-semibold col-span-3">Generate</button>
                        <button onclick="enhanceImage()" class="bg-gray-700 py-2 rounded-md text-sm font-semibold hover:bg-gray-600">Enhance</button>
                        <button onclick="refineImage()" class="bg-gray-700 py-2 rounded-md text-sm font-semibold hover:bg-gray-600">Refine</button>
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-2">Upload Image</h4>
                <div class="upload-area rounded-lg p-4 text-center cursor-pointer" onclick="document.getElementById('file-input').click()">
                    <span class="material-icons text-2xl text-gray-400 mb-2 block">upload_file</span>
                    <span class="text-sm font-semibold text-gray-300">Click to Upload</span>
                </div>
            </div>
        </div>

        <!-- Editing Phase (Hidden initially) -->
        <div id="editing-phase" class="flex-1 overflow-y-auto" style="display: none;">
            <div class="mb-4">
                <h3 class="font-semibold text-sm mb-2 text-subtle-light">Phase 2: Image Editing</h3>
            </div>

            <!-- Basic Tools Category -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-3 flex items-center">
                    <span class="material-icons mr-2">build</span>
                    Basic Tools
                </h4>
                <div class="category-grid">
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="basicEdit('remove_bg')">
                        <span class="material-icons text-primary text-lg block mb-1">layers_clear</span>
                        <span class="text-xs">Remove BG</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="basicEdit('crop_square')">
                        <span class="material-icons text-primary text-lg block mb-1">crop_square</span>
                        <span class="text-xs">Crop</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('flip image horizontally')">
                        <span class="material-icons text-primary text-lg block mb-1">flip</span>
                        <span class="text-xs">Flip</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('rotate image 90 degrees')">
                        <span class="material-icons text-primary text-lg block mb-1">rotate_right</span>
                        <span class="text-xs">Rotate</span>
                    </div>
                </div>
            </div>

            <!-- Adjustments Category -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-3 flex items-center">
                    <span class="material-icons mr-2">tune</span>
                    Adjustments
                </h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm text-subtle-light">Brightness</label>
                        <input id="brightness-slider" class="range-slider w-full mt-1" type="range" min="-100" max="100" value="0" onchange="applyAdjustment()"/>
                    </div>
                    <div>
                        <label class="text-sm text-subtle-light">Contrast</label>
                        <input id="contrast-slider" class="range-slider w-full mt-1" type="range" min="-100" max="100" value="0" onchange="applyAdjustment()"/>
                    </div>
                    <div>
                        <label class="text-sm text-subtle-light">Saturation</label>
                        <input id="saturation-slider" class="range-slider w-full mt-1" type="range" min="-100" max="100" value="0" onchange="applyAdjustment()"/>
                    </div>
                </div>
            </div>

            <!-- Filters Category -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-3 flex items-center">
                    <span class="material-icons mr-2">filter_vintage</span>
                    Filters
                </h4>
                <div class="category-grid">
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('apply black and white filter')">
                        <div class="w-8 h-8 bg-gray-600 rounded mx-auto mb-1 filter grayscale"></div>
                        <span class="text-xs">B&W</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('apply sepia vintage filter')">
                        <div class="w-8 h-8 bg-yellow-800 rounded mx-auto mb-1"></div>
                        <span class="text-xs">Sepia</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('make colors more vibrant')">
                        <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-blue-500 rounded mx-auto mb-1"></div>
                        <span class="text-xs">Vibrant</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('apply vintage retro filter')">
                        <div class="w-8 h-8 bg-orange-800 rounded mx-auto mb-1"></div>
                        <span class="text-xs">Vintage</span>
                    </div>
                </div>
            </div>

            <!-- Effects Category -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-3 flex items-center">
                    <span class="material-icons mr-2">auto_awesome</span>
                    Effects
                </h4>
                <div class="category-grid">
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="basicEdit('enhance')">
                        <span class="material-icons text-primary text-lg block mb-1">auto_fix_high</span>
                        <span class="text-xs">Enhance</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="basicEdit('brighten')">
                        <span class="material-icons text-primary text-lg block mb-1">light_mode</span>
                        <span class="text-xs">Brighten</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('add dramatic studio lighting')">
                        <span class="material-icons text-primary text-lg block mb-1">highlight</span>
                        <span class="text-xs">Drama</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('reduce noise and clean up image')">
                        <span class="material-icons text-primary text-lg block mb-1">cleaning_services</span>
                        <span class="text-xs">Clean</span>
                    </div>
                </div>
            </div>

            <!-- Background Category -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-3 flex items-center">
                    <span class="material-icons mr-2">wallpaper</span>
                    Background
                </h4>
                <div class="category-grid">
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('change background to white')">
                        <div class="w-8 h-8 bg-white rounded mx-auto mb-1"></div>
                        <span class="text-xs">White</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('change background to black')">
                        <div class="w-8 h-8 bg-black rounded mx-auto mb-1"></div>
                        <span class="text-xs">Black</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('add gradient background')">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-500 rounded mx-auto mb-1"></div>
                        <span class="text-xs">Gradient</span>
                    </div>
                    <div class="tool-card bg-gray-800 rounded-lg p-3 text-center cursor-pointer" onclick="quickEdit('blur background for depth of field')">
                        <div class="w-8 h-8 bg-gray-600 rounded mx-auto mb-1 filter blur-sm"></div>
                        <span class="text-xs">Blur</span>
                    </div>
                </div>
            </div>

            <!-- Custom Edit -->
            <div class="mb-6">
                <h4 class="font-medium text-text-light mb-3 flex items-center">
                    <span class="material-icons mr-2">edit</span>
                    Custom Edit
                </h4>
                <div class="space-y-3">
                    <textarea 
                        id="custom-prompt" 
                        class="w-full bg-gray-800 border border-gray-700 rounded-md p-3 text-sm focus:ring-primary focus:border-primary resize-none" 
                        placeholder="Describe your edit..." 
                        rows="3">
                    </textarea>
                    <button onclick="applyCustomEdit()" class="w-full bg-primary text-white py-2 rounded-md text-sm font-semibold hover:bg-primary/90 transition-colors">
                        Apply Edit
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col bg-background-light">
        <!-- Header -->
        <header class="flex items-center justify-between p-4 border-b border-gray-800 bg-surface-light">
            <div>
                <h1 id="main-title" class="text-xl font-bold">Create Your Product Concept</h1>
                <div class="flex items-center text-sm text-subtle-light mt-1">
                    <div id="create-status" class="flex items-center text-accent-green">
                        <span class="material-icons text-lg">check_circle</span>
                        <span class="ml-1 font-semibold">Create</span>
                    </div>
                    <div class="h-1 w-8 bg-gray-700 mx-2 rounded-full">
                        <div id="edit-progress" class="h-1 w-0 bg-accent-blue rounded-full transition-all duration-500"></div>
                    </div>
                    <div id="edit-status" class="flex items-center">
                        <span class="material-icons text-lg">radio_button_unchecked</span>
                        <span class="ml-1">Edit</span>
                    </div>
                    <div class="h-1 w-8 bg-gray-700 mx-2 rounded-full"></div>
                    <div class="flex items-center">
                        <span class="material-icons text-lg">radio_button_unchecked</span>
                        <span class="ml-1">3D Gen</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="undoEdit()" id="undo-btn" class="p-2 rounded-full hover:bg-gray-800 disabled:opacity-50" disabled>
                    <span class="material-icons">undo</span>
                </button>
                <button onclick="downloadImage()" id="export-btn" class="p-2 rounded-full hover:bg-gray-800 disabled:opacity-50" disabled>
                    <span class="material-icons">download</span>
                </button>
                <button onclick="convertTo3D()" id="convert3d-btn" class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 disabled:opacity-50" disabled>
                    <span class="material-icons">view_in_ar</span>
                    Convert to 3D
                </button>
                <img alt="User avatar" class="w-10 h-10 rounded-full" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM4YjVjZjYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC42ODYyOSAxNCA2IDE2LjY4NjMgNiAyMEg2VjIxSDZIMThINlYyMEM2IDE2LjY4NjMgOC42ODYyOSAxNCA2IDEyIDE0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPgo="/>
            </div>
        </header>

        <!-- Canvas Area -->
        <div class="flex-1 flex items-center justify-center p-8">
            <!-- Empty State -->
            <div id="empty-state" class="w-full max-w-4xl h-full flex flex-col items-center justify-center bg-surface-light border-2 border-dashed border-gray-700 rounded-2xl">
                <div class="text-center">
                    <div class="relative w-24 h-24 mx-auto mb-4">
                        <div class="absolute inset-0 bg-primary/30 rounded-full animate-ping"></div>
                        <div class="relative w-24 h-24 bg-primary/40 rounded-full flex items-center justify-center">
                            <span class="material-icons text-primary text-5xl">upload_file</span>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Drag & drop sketches/photos here</h2>
                    <p class="text-subtle-light mb-6">Or use AI text-to-image generation</p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="document.getElementById('file-input').click()" class="flex items-center justify-center px-6 py-3 bg-gradient-to-r from-accent-blue to-primary text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-shadow">
                            <span class="material-icons mr-2">upload</span>
                            Upload Image
                        </button>
                        <button onclick="focusAIPrompt()" class="flex items-center justify-center px-6 py-3 bg-gray-700 text-text-light font-semibold rounded-full hover:bg-gray-600 transition-colors">
                            <span class="material-icons mr-2">auto_awesome</span>
                            Generate with AI
                        </button>
                    </div>
                    <div class="mt-8 text-sm text-subtle-light">
                        <p>No photo? Try one of ours.</p>
                        <div class="flex justify-center space-x-2 mt-2">
                            <img alt="Example 1" class="w-16 h-16 rounded-lg object-cover cursor-pointer hover:opacity-80 transition-opacity" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMzc0MTUxIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNiIgZm9udC1mYW1pbHk9IlJvYm90bywgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzlDQTNBRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RXhhbXBsZSAxPC90ZXh0Pgo8L3N2Zz4="/>
                            <img alt="Example 2" class="w-16 h-16 rounded-lg object-cover cursor-pointer hover:opacity-80 transition-opacity" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNEY0NjVGIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNiIgZm9udC1mYW1pbHk9IlJvYm90bywgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzlDQTNBRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RXhhbXBsZSAyPC90ZXh0Pgo8L3N2Zz4="/>
                            <img alt="Example 3" class="w-16 h-16 rounded-lg object-cover cursor-pointer hover:opacity-80 transition-opacity" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjNjU0Qjg2Ii8+Cjx0ZXh0IHg9IjMyIiB5PSIzNiIgZm9udC1mYW1pbHk9IlJvYm90bywgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMCIgZmlsbD0iIzlDQTNBRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RXhhbXBsZSAzPC90ZXh0Pgo8L3N2Zz4="/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Display -->
            <div id="image-display" style="display: none;" class="w-full h-full flex items-center justify-center p-4">
                <img id="main-image" class="max-h-full max-w-full object-contain rounded-lg shadow-2xl" alt="Working image">
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" style="display: none;" class="border-t border-gray-800 p-4">
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <div class="flex justify-between text-sm mb-2">
                        <span id="progress-text" class="text-text-light">Processing...</span>
                        <span id="progress-percent" class="text-subtle-light">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <button onclick="cancelOperation()" class="text-subtle-light hover:text-red-400 transition-colors">
                    <span class="material-icons">cancel</span>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Hidden File Input -->
<input type="file" id="file-input" accept="image/*" style="display: none;">

<script>
    // Global state
    let currentImage = null;
    let editHistory = [];
    let isProcessing = false;

    // UI Management
    function updateUI() {
        const hasImage = currentImage !== null;
        const hasHistory = editHistory.length > 0;
        
        document.getElementById('export-btn').disabled = !hasImage;
        document.getElementById('convert3d-btn').disabled = !hasImage;
        document.getElementById('undo-btn').disabled = !hasHistory;
        
        if (hasImage) {
            // Switch to editing phase
            document.getElementById('creation-phase').style.display = 'none';
            document.getElementById('editing-phase').style.display = 'block';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('image-display').style.display = 'flex';
            
            // Update header status
            document.getElementById('main-title').textContent = 'Edit Your Image';
            document.getElementById('edit-progress').style.width = '100%';
            document.getElementById('edit-status').innerHTML = '<span class="w-4 h-4 border-2 border-accent-blue rounded-full flex items-center justify-center"><span class="w-1.5 h-1.5 bg-accent-blue rounded-full"></span></span><span class="ml-1 font-semibold">Edit</span>';
            document.getElementById('edit-status').className = 'flex items-center text-accent-blue';
        } else {
            // Switch to creation phase
            document.getElementById('creation-phase').style.display = 'block';
            document.getElementById('editing-phase').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('image-display').style.display = 'none';
            
            // Reset header status
            document.getElementById('main-title').textContent = 'Create Your Product Concept';
            document.getElementById('edit-progress').style.width = '0%';
            document.getElementById('edit-status').innerHTML = '<span class="material-icons text-lg">radio_button_unchecked</span><span class="ml-1">Edit</span>';
            document.getElementById('edit-status').className = 'flex items-center';
        }
    }

    function displayImage(imageData, editDescription = null) {
        currentImage = imageData;
        document.getElementById('main-image').src = 'data:image/png;base64,' + imageData;
        
        if (editDescription) {
            editHistory.push({
                image: imageData,
                description: editDescription,
                timestamp: new Date().toLocaleTimeString()
            });
        }
        
        updateUI();
    }

    // File Upload
    const fileInput = document.getElementById('file-input');
    const uploadAreas = document.querySelectorAll('.upload-area');

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleImageUpload(e.target.files[0]);
        }
    });

    // Drag and drop for main canvas
    const emptyState = document.getElementById('empty-state');
    emptyState.addEventListener('dragover', (e) => {
        e.preventDefault();
        emptyState.classList.add('dragover');
    });

    emptyState.addEventListener('dragleave', () => {
        emptyState.classList.remove('dragover');
    });

    emptyState.addEventListener('drop', (e) => {
        e.preventDefault();
        emptyState.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleImageUpload(files[0]);
        }
    });

    function handleImageUpload(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const base64Data = e.target.result.split(',')[1];
            displayImage(base64Data, 'Uploaded image');
        };
        reader.readAsDataURL(file);
    }

    // Progress Management
    function showProgress(text, percent = 0) {
        isProcessing = true;
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('progress-text').textContent = text;
        updateProgress(percent);
    }

    function updateProgress(percent) {
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-percent').textContent = Math.round(percent) + '%';
    }

    function hideProgress() {
        isProcessing = false;
        document.getElementById('progress-container').style.display = 'none';
    }

    function cancelOperation() {
        if (isProcessing) {
            hideProgress();
        }
    }

    // AI Generation
    async function generateWithAI() {
        const prompt = document.getElementById('ai-prompt').value.trim();
        if (!prompt) {
            alert('Please enter a description for your image');
            return;
        }

        showProgress('Generating image with AI...', 0);
        
        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: prompt,
                    guidance_scale: 7.5,
                    num_inference_steps: 28,
                    width: 1024,
                    height: 1024
                })
            });

            const result = await response.json();

            if (result.success) {
                displayImage(result.image, `Generated: ${prompt}`);
                hideProgress();
            } else {
                hideProgress();
                alert('Error: ' + (result.message || result.detail || 'Failed to generate image'));
            }
            
        } catch (error) {
            hideProgress();
            alert('Error generating image: ' + error.message);
        }
    }

    // Quick Edits
    async function quickEdit(prompt) {
        if (!currentImage) {
            alert('Please upload or generate an image first');
            return;
        }

        showProgress(`Applying: ${prompt}`, 0);
        
        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: prompt,
                    image_base64: currentImage,
                    guidance_scale: 3.5,
                    num_inference_steps: 28,
                    width: 1024,
                    height: 1024
                })
            });

            const result = await response.json();
            
            if (result.success) {
                displayImage(result.image, prompt);
                hideProgress();
            } else {
                hideProgress();
                alert('Error: ' + (result.message || result.detail || 'Failed to edit image'));
            }
        } catch (error) {
            hideProgress();
            alert('Error editing image: ' + error.message);
        }
    }

    // Basic Edit Functions (non-Flux for simple operations)
    async function basicEdit(operation) {
        if (!currentImage) {
            alert('Please upload or generate an image first');
            return;
        }

        let endpoint = '/api/basic-edit';
        let prompt = '';
        
        switch(operation) {
            case 'remove_bg':
                endpoint = '/api/remove-background';
                prompt = 'Removing background';
                break;
            case 'brighten':
                endpoint = '/api/adjust-image';
                prompt = 'Brightening image';
                break;
            case 'enhance':
                endpoint = '/api/enhance-image';
                prompt = 'Enhancing image quality';
                break;
            case 'crop_square':
                endpoint = '/api/crop-image';
                prompt = 'Cropping to square';
                break;
            default:
                await quickEdit(operation);
                return;
        }

        showProgress(prompt, 0);
        
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_base64: currentImage,
                    operation: operation
                })
            });

            const result = await response.json();
            
            if (result.success) {
                displayImage(result.image, prompt);
                hideProgress();
            } else {
                // Fallback to Flux if basic operation fails
                hideProgress();
                const fallbackPrompts = {
                    'remove_bg': 'remove background completely',
                    'brighten': 'make image brighter and more vibrant',
                    'enhance': 'enhance image quality and sharpness',
                    'crop_square': 'crop image to square aspect ratio'
                };
                await quickEdit(fallbackPrompts[operation] || operation);
            }
        } catch (error) {
            hideProgress();
            // Fallback to Flux on error
            const fallbackPrompts = {
                'remove_bg': 'remove background completely',
                'brighten': 'make image brighter and more vibrant',
                'enhance': 'enhance image quality and sharpness',
                'crop_square': 'crop image to square aspect ratio'
            };
            await quickEdit(fallbackPrompts[operation] || operation);
        }
    }

    // Custom Edit
    async function applyCustomEdit() {
        const prompt = document.getElementById('custom-prompt').value.trim();
        if (!prompt) {
            alert('Please enter an edit description');
            return;
        }

        await quickEdit(prompt);
        document.getElementById('custom-prompt').value = '';
    }

    // Adjustment Functions
    function applyAdjustment() {
        if (!currentImage) return;
        
        const brightness = document.getElementById('brightness-slider').value;
        const contrast = document.getElementById('contrast-slider').value;
        const saturation = document.getElementById('saturation-slider').value;
        
        let adjustmentPrompt = 'adjust image with ';
        const adjustments = [];
        
        if (brightness != 0) adjustments.push(`brightness ${brightness > 0 ? 'increased' : 'decreased'} by ${Math.abs(brightness)}%`);
        if (contrast != 0) adjustments.push(`contrast ${contrast > 0 ? 'increased' : 'decreased'} by ${Math.abs(contrast)}%`);
        if (saturation != 0) adjustments.push(`saturation ${saturation > 0 ? 'increased' : 'decreased'} by ${Math.abs(saturation)}%`);
        
        if (adjustments.length > 0) {
            adjustmentPrompt += adjustments.join(', ');
            quickEdit(adjustmentPrompt);
        }
    }

    // Utility Functions
    function undoEdit() {
        if (editHistory.length > 1) {
            editHistory.pop();
            const previous = editHistory[editHistory.length - 1];
            currentImage = previous.image;
            document.getElementById('main-image').src = 'data:image/png;base64,' + currentImage;
            updateUI();
        } else if (editHistory.length === 1) {
            editHistory = [];
            currentImage = null;
            updateUI();
        }
    }

    function downloadImage() {
        if (currentImage) {
            const link = document.createElement('a');
            link.download = 'make3d-edited-image.png';
            link.href = 'data:image/png;base64,' + currentImage;
            link.click();
        }
    }

    function convertTo3D() {
        if (!currentImage) {
            alert('Please create or upload an image first');
            return;
        }
        
        showProgress('Converting to 3D model...', 0);
        
        setTimeout(() => {
            hideProgress();
            alert('3D conversion will be implemented with Hunyuan 3D integration');
        }, 3000);
    }

    function focusAIPrompt() {
        document.getElementById('ai-prompt').focus();
    }

    function enhanceImage() {
        if (currentImage) {
            basicEdit('enhance');
        } else {
            alert('Please upload or generate an image first');
        }
    }

    function refineImage() {
        if (currentImage) {
            quickEdit('refine and improve image quality with better details');
        } else {
            alert('Please upload or generate an image first');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateUI();
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        undoEdit();
                        break;
                    case 'o':
                        e.preventDefault();
                        document.getElementById('file-input').click();
                        break;
                    case 's':
                        e.preventDefault();
                        downloadImage();
                        break;
                }
            }
        });
    });
</script>
</body>
</html>