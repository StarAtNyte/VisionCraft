<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Make3D Studio - Editor</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1f71d6",
                        "background-light": "#f6f7f8",
                        "background-dark": "#111821",
                    },
                    fontFamily: {
                        "display": ["Inter"],
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
        }
        .tool-button {
            transition: all 0.2s ease;
        }
        .tool-button:hover {
            transform: translateY(-1px);
        }
        .tool-button.active {
            background: #1f71d6;
            color: white;
        }
        .canvas-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
        }
        #editor-canvas {
            cursor: crosshair;
            display: block;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .range-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1f71d6;
            cursor: pointer;
        }
        .range-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1f71d6;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
    <!-- Header -->
    <header class="flex h-16 shrink-0 items-center justify-between border-b border-gray-200/10 dark:border-gray-700/50 px-6">
        <div class="flex items-center gap-4">
            <button onclick="goHome()" class="flex items-center gap-2 text-gray-600 hover:text-primary dark:text-gray-300 dark:hover:text-primary">
                <span class="material-symbols-outlined">arrow_back</span>
                Back to Home
            </button>
            <div class="h-6 w-px bg-gray-300 dark:bg-gray-600"></div>
            <div class="flex items-center gap-4">
                <div class="text-primary size-7">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_6_535)">
                            <path clip-rule="evenodd" d="M47.2426 24L24 47.2426L0.757355 24L24 0.757355L47.2426 24ZM12.2426 21H35.7574L24 9.24264L12.2426 21Z" fill="currentColor" fill-rule="evenodd"></path>
                        </g>
                        <defs>
                            <clipPath id="clip0_6_535">
                                <rect fill="white" height="48" width="48"></rect>
                            </clipPath>
                        </defs>
                    </svg>
                </div>
                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Make3D Studio - Editor</h2>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="document.getElementById('file-input').click()" class="flex h-9 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-gray-600 px-4 text-sm font-semibold text-white transition-all hover:bg-gray-700">
                <span class="material-symbols-outlined text-base">upload</span>
                <span>Upload</span>
            </button>
            <button onclick="saveProject()" class="flex h-9 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-green-600 px-4 text-sm font-semibold text-white transition-all hover:bg-green-700">
                <span class="material-symbols-outlined text-base">save</span>
                <span>Save</span>
            </button>
            <button onclick="exportImage()" class="flex h-9 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-primary px-4 text-sm font-semibold text-white transition-all hover:bg-primary/90">
                <span class="material-symbols-outlined text-base">download</span>
                <span>Export</span>
            </button>
            <button onclick="convertTo3D()" class="flex h-9 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-purple-600 px-4 text-sm font-semibold text-white transition-all hover:bg-purple-700">
                <span class="material-symbols-outlined text-base">view_in_ar</span>
                <span>3D Convert</span>
            </button>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </header>

    <div class="flex h-[calc(100vh-4rem)]">
        <!-- Toolbar -->
        <div class="w-80 border-r border-gray-200/10 dark:border-gray-700/50 bg-white/50 dark:bg-gray-800/50 p-6 overflow-y-auto">
            <div class="space-y-6">
                <!-- Tools Section -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Tools</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectTool('brush')" class="tool-button flex flex-col items-center gap-2 rounded-lg border border-gray-300 bg-white p-3 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" id="brush-tool">
                            <span class="material-symbols-outlined text-xl">brush</span>
                            Brush
                        </button>
                        <button onclick="selectTool('eraser')" class="tool-button flex flex-col items-center gap-2 rounded-lg border border-gray-300 bg-white p-3 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" id="eraser-tool">
                            <span class="material-symbols-outlined text-xl">auto_fix_high</span>
                            Eraser
                        </button>
                        <button onclick="selectTool('move')" class="tool-button flex flex-col items-center gap-2 rounded-lg border border-gray-300 bg-white p-3 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" id="move-tool">
                            <span class="material-symbols-outlined text-xl">pan_tool</span>
                            Move
                        </button>
                    </div>
                </div>

                <!-- Brush Settings -->
                <div id="brush-settings">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Brush Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Size</label>
                            <div class="slider-container">
                                <input type="range" id="brush-size" class="range-slider" min="1" max="100" value="10">
                                <span id="brush-size-value" class="text-sm font-medium text-gray-600 dark:text-gray-400 w-8">10</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Opacity</label>
                            <div class="slider-container">
                                <input type="range" id="brush-opacity" class="range-slider" min="0" max="100" value="100">
                                <span id="brush-opacity-value" class="text-sm font-medium text-gray-600 dark:text-gray-400 w-8">100</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Color</label>
                            <input type="color" id="brush-color" value="#000000" class="w-full h-10 rounded-lg border border-gray-300 dark:border-gray-600">
                        </div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Filters</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Brightness</label>
                            <div class="slider-container">
                                <input type="range" id="brightness" class="range-slider" min="-100" max="100" value="0">
                                <span id="brightness-value" class="text-sm font-medium text-gray-600 dark:text-gray-400 w-8">0</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contrast</label>
                            <div class="slider-container">
                                <input type="range" id="contrast" class="range-slider" min="-100" max="100" value="0">
                                <span id="contrast-value" class="text-sm font-medium text-gray-600 dark:text-gray-400 w-8">0</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Saturation</label>
                            <div class="slider-container">
                                <input type="range" id="saturation" class="range-slider" min="-100" max="100" value="0">
                                <span id="saturation-value" class="text-sm font-medium text-gray-600 dark:text-gray-400 w-8">0</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Blur</label>
                            <div class="slider-container">
                                <input type="range" id="blur" class="range-slider" min="0" max="20" value="0">
                                <span id="blur-value" class="text-sm font-medium text-gray-600 dark:text-gray-400 w-8">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Actions</h3>
                    <div class="space-y-2">
                        <button onclick="undoAction()" class="w-full flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                            <span class="material-symbols-outlined text-base">undo</span>
                            Undo
                        </button>
                        <button onclick="redoAction()" class="w-full flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                            <span class="material-symbols-outlined text-base">redo</span>
                            Redo
                        </button>
                        <button onclick="clearCanvas()" class="w-full flex items-center gap-2 rounded-lg bg-red-100 px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-200 dark:bg-red-900 dark:text-red-300 dark:hover:bg-red-800">
                            <span class="material-symbols-outlined text-base">clear</span>
                            Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="flex-1 flex flex-col">
            <div class="flex-1 p-6 flex items-center justify-center">
                <div class="canvas-container max-w-full max-h-full">
                    <canvas id="editor-canvas" width="800" height="600" class="border border-gray-300 dark:border-gray-600 bg-white"></canvas>
                </div>
            </div>
            
            <!-- Bottom Controls -->
            <div class="border-t border-gray-200/10 dark:border-gray-700/50 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="zoomIn()" class="flex items-center gap-1 rounded-lg bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                            <span class="material-symbols-outlined text-base">zoom_in</span>
                            Zoom In
                        </button>
                        <button onclick="zoomOut()" class="flex items-center gap-1 rounded-lg bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                            <span class="material-symbols-outlined text-base">zoom_out</span>
                            Zoom Out
                        </button>
                        <button onclick="resetZoom()" class="flex items-center gap-1 rounded-lg bg-gray-100 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                            <span class="material-symbols-outlined text-base">fit_screen</span>
                            Fit
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        Zoom: <span id="zoom-level">100%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Editor state
        let currentTool = 'brush';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let canvas = document.getElementById('editor-canvas');
        let ctx = canvas.getContext('2d');
        let history = [];
        let historyIndex = -1;
        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;

        // Initialize canvas
        function initCanvas() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();
        }

        // Load image from URL parameter or storage
        function loadImage() {
            const urlParams = new URLSearchParams(window.location.search);
            const imageData = urlParams.get('image');
            
            if (imageData) {
                const img = new Image();
                img.onload = function() {
                    // Resize canvas to fit image
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    saveState();
                };
                img.src = 'data:image/png;base64,' + imageData;
            }
        }

        // Tool selection
        function selectTool(tool) {
            // Remove active class from all tools
            document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
            // Add active class to selected tool
            document.getElementById(tool + '-tool').classList.add('active');
            currentTool = tool;
            
            // Update cursor
            if (tool === 'brush') {
                canvas.style.cursor = 'crosshair';
            } else if (tool === 'eraser') {
                canvas.style.cursor = 'grab';
            } else if (tool === 'move') {
                canvas.style.cursor = 'move';
            }
        }

        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getMousePos(e);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const [currentX, currentY] = getMousePos(e);
            
            if (currentTool === 'brush') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = document.getElementById('brush-color').value;
                ctx.lineWidth = document.getElementById('brush-size').value;
                ctx.globalAlpha = document.getElementById('brush-opacity').value / 100;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
            } else if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = document.getElementById('brush-size').value;
                ctx.globalAlpha = 1;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
            }
            
            [lastX, lastY] = [currentX, currentY];
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            saveState();
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return [
                (e.clientX - rect.left) / zoomLevel,
                (e.clientY - rect.top) / zoomLevel
            ];
        }

        // Canvas event listeners
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events for mobile
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            canvas.dispatchEvent(mouseEvent);
        });

        // Filter functions
        function applyFilters() {
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const saturation = document.getElementById('saturation').value;
            const blur = document.getElementById('blur').value;
            
            let filters = '';
            if (brightness != 0) filters += `brightness(${(parseInt(brightness) + 100)}%) `;
            if (contrast != 0) filters += `contrast(${(parseInt(contrast) + 100)}%) `;
            if (saturation != 0) filters += `saturate(${(parseInt(saturation) + 100)}%) `;
            if (blur != 0) filters += `blur(${blur}px) `;
            
            canvas.style.filter = filters;
        }

        // Slider event listeners
        document.getElementById('brush-size').addEventListener('input', (e) => {
            document.getElementById('brush-size-value').textContent = e.target.value;
        });

        document.getElementById('brush-opacity').addEventListener('input', (e) => {
            document.getElementById('brush-opacity-value').textContent = e.target.value;
        });

        document.getElementById('brightness').addEventListener('input', (e) => {
            document.getElementById('brightness-value').textContent = e.target.value;
            applyFilters();
        });

        document.getElementById('contrast').addEventListener('input', (e) => {
            document.getElementById('contrast-value').textContent = e.target.value;
            applyFilters();
        });

        document.getElementById('saturation').addEventListener('input', (e) => {
            document.getElementById('saturation-value').textContent = e.target.value;
            applyFilters();
        });

        document.getElementById('blur').addEventListener('input', (e) => {
            document.getElementById('blur-value').textContent = e.target.value;
            applyFilters();
        });

        // History management
        function saveState() {
            historyIndex++;
            if (historyIndex < history.length) {
                history.length = historyIndex;
            }
            history.push(canvas.toDataURL());
        }

        function undoAction() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreState();
            }
        }

        function redoAction() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreState();
            }
        }

        function restoreState() {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = history[historyIndex];
        }

        function clearCanvas() {
            if (confirm('Are you sure you want to clear the entire canvas?')) {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                saveState();
            }
        }

        // Zoom functions
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 5);
            updateZoom();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.1);
            updateZoom();
        }

        function resetZoom() {
            zoomLevel = 1;
            updateZoom();
        }

        function updateZoom() {
            canvas.style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoom-level').textContent = Math.round(zoomLevel * 100) + '%';
        }

        // Export and save functions
        function exportImage() {
            // Apply filters to actual canvas data before export
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            // Draw current canvas to temp canvas
            tempCtx.drawImage(canvas, 0, 0);
            
            // Create download link
            const link = document.createElement('a');
            link.download = 'make3d-edited-image.png';
            link.href = tempCanvas.toDataURL();
            link.click();
        }

        function saveProject() {
            // Save to localStorage for now
            const projectData = {
                canvas: canvas.toDataURL(),
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('make3d-current-project', JSON.stringify(projectData));
            alert('Project saved successfully!');
        }

        function goHome() {
            if (confirm('Are you sure you want to leave the editor? Unsaved changes will be lost.')) {
                window.location.href = '/';
            }
        }

        // File upload in editor
        document.getElementById('file-input').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        saveState();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 3D Conversion function
        function convertTo3D() {
            const imageData = canvas.toDataURL();
            const base64Data = imageData.split(',')[1];
            
            // Show loading state
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md mx-4">
                    <div class="text-center">
                        <div class="mx-auto mb-4 h-12 w-12 animate-spin rounded-full border-4 border-purple-600 border-t-transparent"></div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Converting to 3D</h3>
                        <p class="text-gray-600 dark:text-gray-300">This may take 2-3 minutes...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            // TODO: Implement actual 3D conversion API call
            setTimeout(() => {
                document.body.removeChild(loadingModal);
                alert('3D conversion will be implemented with Hunyuan 3D 2.0 integration');
            }, 2000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initCanvas();
            loadImage();
            selectTool('brush');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redoAction();
                        } else {
                            undoAction();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        saveProject();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportImage();
                        break;
                }
            }
        });
    </script>
</body>
</html>