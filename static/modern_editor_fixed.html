<!DOCTYPE html>
<!-- Cache buster: Two-column layout like screenshot v4.0 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make3D Studio - AI Product Image Creator</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a1a1a',
                        'dark-surface': '#2d2d2d',
                        'dark-border': '#404040',
                        'dark-text': '#e5e5e5',
                        'dark-text-secondary': '#a3a3a3',
                        'primary': '#14b8a6'
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'slide-out': 'slideOut 0.3s ease-in'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        slideOut: {
                            '0%': { transform: 'translateX(0)', opacity: '1' },
                            '100%': { transform: 'translateX(100%)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            margin: 0; 
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            width: 100%;
            overflow-x: hidden;
        }
        * {
            box-sizing: border-box;
        }
        html, body, #root {
            width: 100%;
            height: 100%;
        }
        button {
            font-family: inherit;
        }
        input, textarea, select {
            font-family: inherit;
        }
        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 50;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            background-color: #111827;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .tooltip-trigger:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .gradient-primary {
            background: linear-gradient(135deg, #14b8a6 0%, #8b5cf6 100%);
        }
        .gradient-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(45, 45, 45, 0.8);
        }
        .upload-zone {
            border: 2px dashed #404040;
            transition: all 0.3s ease;
        }
        .upload-zone:hover {
            border-color: #14b8a6;
            background-color: rgba(20, 184, 166, 0.05);
        }
        .upload-zone.dragover {
            border-color: #14b8a6;
            background-color: rgba(20, 184, 166, 0.1);
        }
        .sidebar-icon {
            transition: all 0.2s ease;
        }
        .sidebar-icon:hover {
            transform: translateY(-2px);
        }
        .tool-panel {
            animation: slideIn 0.3s ease-out;
        }
        .tool-panel.closing {
            animation: slideOut 0.3s ease-in;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.15) rotate(5deg); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-dark-bg text-dark-text">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Icon components using SVG directly
        const Icons = {
            Upload: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
                React.createElement('polyline', { points: '8,12 12,8 16,12' }),
                React.createElement('line', { x1: 12, y1: 8, x2: 12, y2: 16 })
            ),
            Sliders: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('line', { x1: 4, y1: 21, x2: 4, y2: 14 }),
                React.createElement('line', { x1: 4, y1: 10, x2: 4, y2: 3 }),
                React.createElement('line', { x1: 12, y1: 21, x2: 12, y2: 12 }),
                React.createElement('line', { x1: 12, y1: 8, x2: 12, y2: 3 }),
                React.createElement('line', { x1: 20, y1: 21, x2: 20, y2: 16 }),
                React.createElement('line', { x1: 20, y1: 12, x2: 20, y2: 3 }),
                React.createElement('line', { x1: 1, y1: 14, x2: 7, y2: 14 }),
                React.createElement('line', { x1: 9, y1: 8, x2: 15, y2: 8 }),
                React.createElement('line', { x1: 17, y1: 16, x2: 23, y2: 16 })
            ),
            Wand2: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'm21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z' }),
                React.createElement('path', { d: 'm14 7 3 3' }),
                React.createElement('path', { d: 'M5 6v4' }),
                React.createElement('path', { d: 'M19 14v4' }),
                React.createElement('path', { d: 'M10 2v2' }),
                React.createElement('path', { d: 'M7 8H3' }),
                React.createElement('path', { d: 'M21 16h-4' }),
                React.createElement('path', { d: 'M11 3H9' })
            ),
            Camera: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('rect', { x: 2, y: 3, width: 6, height: 6, rx: 1 }),
                React.createElement('rect', { x: 9, y: 3, width: 6, height: 6, rx: 1 }),
                React.createElement('rect', { x: 16, y: 3, width: 6, height: 6, rx: 1 }),
                React.createElement('rect', { x: 2, y: 12, width: 6, height: 6, rx: 1 }),
                React.createElement('rect', { x: 9, y: 12, width: 6, height: 6, rx: 1 }),
                React.createElement('rect', { x: 16, y: 12, width: 6, height: 6, rx: 1 })
            ),
            Users: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('circle', { cx: 12, cy: 7, r: 3 }),
                React.createElement('path', { d: 'M12 14c-4 0-7 2-7 5v2h14v-2c0-3-3-5-7-5z' }),
                React.createElement('path', { d: 'M8 21l8-8M16 21l-8-8', opacity: 0.5 })
            ),
            Play: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('polygon', { points: '5,3 19,12 5,21' }),
                React.createElement('path', { d: 'm22 6-3 3', opacity: 0.6 }),
                React.createElement('path', { d: 'm22 12-3 3', opacity: 0.6 }),
                React.createElement('path', { d: 'm22 18-3 3', opacity: 0.6 })
            ),
            Box: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'M12 2L2 7v10l10 5 10-5V7L12 2z' }),
                React.createElement('polyline', { points: '2,7 12,12 22,7' }),
                React.createElement('line', { x1: 12, y1: 22, x2: 12, y2: 12 }),
                React.createElement('path', { d: 'M17 4.5L7 9.5', opacity: 0.4 })
            ),
            Search: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('circle', { cx: 11, cy: 11, r: 8 }),
                React.createElement('path', { d: 'M21 21l-4.35-4.35' })
            ),
            Download: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
                React.createElement('polyline', { points: '7,10 12,15 17,10' }),
                React.createElement('line', { x1: 12, y1: 15, x2: 12, y2: 3 })
            ),
            ChevronDown: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('polyline', { points: '6,9 12,15 18,9' })
            ),
            X: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('line', { x1: 18, y1: 6, x2: 6, y2: 18 }),
                React.createElement('line', { x1: 6, y1: 6, x2: 18, y2: 18 })
            ),
            RotateCw: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'M21 2v6h-6' }),
                React.createElement('path', { d: 'M21 13a9 9 0 1 1-3-7.7L21 8' })
            ),
            Crop: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'M6 2v14a2 2 0 0 0 2 2h14' }),
                React.createElement('path', { d: 'M18 6H8a2 2 0 0 0-2 2v10' })
            ),
            Brush: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'm9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08' }),
                React.createElement('path', { d: 'M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z' })
            ),
            Pen: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'M12 19l7-7 3 3-7 7-3-3z' }),
                React.createElement('path', { d: 'M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z' }),
                React.createElement('path', { d: 'M2 2l7.586 7.586' }),
                React.createElement('circle', { cx: 11, cy: 11, r: 2 })
            ),
            Eraser: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'm7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21' }),
                React.createElement('path', { d: 'M22 21H7' }),
                React.createElement('path', { d: 'm5 11 9 9' })
            ),
            Square: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('rect', { x: 3, y: 3, width: 18, height: 18, rx: 2, ry: 2 })
            ),
            Circle: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('circle', { cx: 12, cy: 12, r: 10 })
            ),
            Minus: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('line', { x1: 5, y1: 12, x2: 19, y2: 12 })
            ),
            ArrowUpRight: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('line', { x1: 7, y1: 17, x2: 17, y2: 7 }),
                React.createElement('polyline', { points: '7,7 17,7 17,17' })
            ),
            Type: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('polyline', { points: '4,7 4,4 20,4 20,7' }),
                React.createElement('line', { x1: 9, y1: 20, x2: 15, y2: 20 }),
                React.createElement('line', { x1: 12, y1: 4, x2: 12, y2: 20 })
            ),
            Palette: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('circle', { cx: 13.5, cy: 6.5, r: '.5' }),
                React.createElement('circle', { cx: 17.5, cy: 10.5, r: '.5' }),
                React.createElement('circle', { cx: 8.5, cy: 7.5, r: '.5' }),
                React.createElement('circle', { cx: 6.5, cy: 12.5, r: '.5' }),
                React.createElement('path', { d: 'M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z' })
            ),
            Layers: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('polygon', { points: '12,2 2,7 12,12 22,7 12,2' }),
                React.createElement('polyline', { points: '2,17 12,22 22,17' }),
                React.createElement('polyline', { points: '2,12 12,17 22,12' })
            ),
            Undo: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'M3 7v6h6' }),
                React.createElement('path', { d: 'm21 17-9.5-9.5' }),
                React.createElement('path', { d: 'M9 7H3l6 6' })
            ),
            Redo: (props) => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', ...props },
                React.createElement('path', { d: 'M21 7v6h-6' }),
                React.createElement('path', { d: 'm3 17 9.5-9.5' }),
                React.createElement('path', { d: 'M15 7h6l-6 6' })
            ),
        };

        // Main App Component
        const App = () => {
            const [activeToolId, setActiveToolId] = useState(null);
            const [uploadedImage, setUploadedImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processingText, setProcessingText] = useState('');
            const [progress, setProgress] = useState(0);
            const [panelClosing, setPanelClosing] = useState(false);
            const [fabricCanvas, setFabricCanvas] = useState(null);
            const [colorVariants, setColorVariants] = useState([]); // Shared state for color variants

            const tools = [
                { id: 'upload', name: 'Upload/Import', icon: Icons.Upload, description: 'Upload images or import from URL' },
                { id: 'basic', name: 'Basic Edits', icon: Icons.Sliders, description: 'Crop, rotate, adjust brightness & filters' },
                { id: 'ai', name: 'AI Edits', icon: Icons.Wand2, description: 'AI-powered editing with Flux integration' },
                { id: 'shots', name: 'Color Variants', icon: Icons.Palette, description: 'Generate different color variations' },
                { id: 'lifestyle', name: 'Lifestyle Mockups', icon: Icons.Users, description: 'Show products in real environments' },
                { id: 'animation', name: 'Animation', icon: Icons.Play, description: 'Create animated product videos' },
                { id: '3d', name: '3D Mockups', icon: Icons.Box, description: 'Generate 3D product renders' },
            ];

            const handleToolClick = (toolId) => {
                if (activeToolId === toolId) {
                    setPanelClosing(true);
                    setTimeout(() => {
                        setActiveToolId(null);
                        setPanelClosing(false);
                    }, 300);
                } else {
                    setActiveToolId(toolId);
                    setPanelClosing(false);
                }
            };

            const closePanel = () => {
                setPanelClosing(true);
                setTimeout(() => {
                    setActiveToolId(null);
                    setPanelClosing(false);
                }, 300);
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', height: '100vh', backgroundColor: '#111827' }}>
                    {/* Top Navigation - Full Width */}
                    <TopNavigation uploadedImage={uploadedImage} />

                    {/* Main Content Area with Sidebar */}
                    <div style={{ display: 'flex', flex: 1, overflow: 'hidden', width: '100%' }}>
                        {/* Left Sidebar */}
                        <Sidebar 
                            tools={tools} 
                            activeToolId={activeToolId} 
                            onToolClick={handleToolClick} 
                        />

                        {/* Main Content - Adjust width based on panel visibility */}
                        <div style={{ 
                            flex: 1, 
                            display: 'flex', 
                            width: activeToolId ? 'calc(100% - 360px)' : '100%', 
                            minWidth: 0,
                            transition: 'width 0.3s ease'
                        }}>
                            <MainContent 
                                uploadedImage={uploadedImage}
                                setUploadedImage={setUploadedImage}
                                isProcessing={isProcessing}
                                processingText={processingText}
                                progress={progress}
                                setIsProcessing={setIsProcessing}
                                setProcessingText={setProcessingText}
                                setProgress={setProgress}
                                activeToolId={activeToolId}
                                fabricCanvas={fabricCanvas}
                                setFabricCanvas={setFabricCanvas}
                                colorVariants={colorVariants}
                                setColorVariants={setColorVariants}
                            />
                        </div>

                        {/* Tool Panel */}
                        {activeToolId && (
                            <ToolPanel 
                                toolId={activeToolId}
                                onClose={closePanel}
                                uploadedImage={uploadedImage}
                                setUploadedImage={setUploadedImage}
                                setIsProcessing={setIsProcessing}
                                setProcessingText={setProcessingText}
                                setProgress={setProgress}
                                isClosing={panelClosing}
                                colorVariants={colorVariants}
                                setColorVariants={setColorVariants}
                                fabricCanvas={fabricCanvas}
                            />
                        )}
                    </div>
                </div>
            );
        };

        // Sidebar Component - Icons Only
        const Sidebar = ({ tools, activeToolId, onToolClick }) => {
            return (
                <div style={{
                    width: '72px',
                    backgroundColor: '#1f2937',
                    borderRight: '1px solid #374151',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    paddingTop: '24px',
                    paddingBottom: '24px'
                }}>
                    {tools.map((tool, index) => {
                        const isActive = activeToolId === tool.id;
                        
                        return (
                            <div key={tool.id} style={{ 
                                position: 'relative',
                                marginBottom: index < tools.length - 1 ? '16px' : '0'
                            }} className="tooltip-trigger">
                                <button
                                    onClick={() => onToolClick(tool.id)}
                                    data-tool={tool.id}
                                    style={{
                                        width: '44px',
                                        height: '44px',
                                        borderRadius: '12px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        transition: 'all 0.2s ease',
                                        border: 'none',
                                        cursor: 'pointer',
                                        background: isActive 
                                            ? 'linear-gradient(135deg, #14b8a6 0%, #8b5cf6 100%)'
                                            : '#1a1a1a',
                                        color: isActive ? '#ffffff' : '#a3a3a3',
                                        boxShadow: isActive ? '0 4px 12px rgba(20, 184, 166, 0.3)' : 'none'
                                    }}
                                    className="sidebar-icon"
                                    onMouseEnter={(e) => {
                                        if (!isActive) {
                                            e.target.style.backgroundColor = '#374151';
                                            e.target.style.color = '#ffffff';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (!isActive) {
                                            e.target.style.backgroundColor = '#1a1a1a';
                                            e.target.style.color = '#a3a3a3';
                                        }
                                    }}
                                >
                                    <tool.icon style={{ width: '20px', height: '20px' }} />
                                </button>
                                <div className="tooltip" style={{
                                    position: 'absolute',
                                    left: '100%',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    marginLeft: '12px',
                                    whiteSpace: 'nowrap',
                                    fontSize: '13px',
                                    fontWeight: '500',
                                    backgroundColor: '#1f2937',
                                    border: '1px solid #374151',
                                    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '2px'
                                    }}>
                                        <div style={{ fontWeight: '600', color: '#ffffff' }}>{tool.name}</div>
                                        <div style={{ fontSize: '11px', color: '#9ca3af', maxWidth: '200px', lineHeight: '1.3' }}>{tool.description}</div>
                                    </div>
                                    <div style={{
                                        position: 'absolute',
                                        left: '-4px',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        width: '8px',
                                        height: '8px',
                                        backgroundColor: '#1f2937',
                                        border: '1px solid #374151',
                                        borderRight: 'none',
                                        borderTop: 'none',
                                        transform: 'translateY(-50%) rotate(45deg)'
                                    }} />
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // Top Navigation Component - Header matching dark theme
        const TopNavigation = ({ uploadedImage }) => {
            const saveImage = () => {
                if (uploadedImage) {
                    const link = document.createElement('a');
                    link.href = uploadedImage;
                    link.download = 'visioncraft-image.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            return (
                <header className="flex h-16 shrink-0 items-center justify-between border-b border-gray-700 px-6 bg-gray-900">
                    <div className="flex items-center gap-5">
                        <div className="text-primary size-9 rounded-xl bg-primary/10 flex items-center justify-center shadow-lg">
                            <Icons.Box style={{ width: '24px', height: '24px', color: 'currentColor' }} />
                        </div>
                        <h2 className="text-2xl font-extrabold text-gray-900 dark:text-white tracking-tight">VisionCraft</h2>
                    </div>
                    <div className="flex-1"></div>

                    {/* Right: Save Image Button */}
                    {uploadedImage && (
                        <div className="flex items-center">
                            <button 
                                onClick={saveImage}
                                className="flex h-9 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-primary px-4 text-sm font-semibold text-white transition-all hover:bg-primary/90"
                            >
                                <Icons.Download style={{ width: '16px', height: '16px' }} />
                                <span>Save Image</span>
                            </button>
                        </div>
                    )}
                </header>
            );
        };

        // Enhanced Main Content Component - AI Generation, Upload, and Lifestyle Galleries
        const MainContent = ({ uploadedImage, setUploadedImage, isProcessing, processingText, progress, setIsProcessing, setProcessingText, setProgress, activeToolId, fabricCanvas, setFabricCanvas, colorVariants, setColorVariants }) => {
            const fileInputRef = useRef(null);
            const mainCanvasRef = useRef(null);
            const [isDragOver, setIsDragOver] = useState(false);
            const [prompt, setPrompt] = useState('');
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            
            // Enhanced UI states
            const [lifestyleScenarios, setLifestyleScenarios] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState('electronics');
            const [selectedVariants, setSelectedVariants] = useState([]);
            const [isGeneratingVariants, setIsGeneratingVariants] = useState(false);
            const [isGeneratingScenarios, setIsGeneratingScenarios] = useState(false);
            const [modalImage, setModalImage] = useState(null);
            const [viewMode, setViewMode] = useState('upload'); // 'upload', 'variants', 'scenarios'

            // Product categories for lifestyle scenarios
            const productCategories = {
                footwear: { name: 'Footwear', scenarios: [
                    { name: 'Street Style', prompt: 'Person wearing the shoes walking on a modern city street, urban fashion photography, street style outfit, natural outdoor lighting, casual lifestyle' },
                    { name: 'Gym Workout', prompt: 'Athletic person wearing the shoes in a modern gym, fitness environment, workout session, sports photography, dynamic fitness lifestyle' }
                ]},
                headphones: { name: 'Audio/Headphones', scenarios: [
                    { name: 'Music Studio', prompt: 'Person wearing headphones in a professional music studio, music production setup, recording environment, creative workspace' },
                    { name: 'Gaming Setup', prompt: 'Person wearing headphones at a modern gaming setup, RGB lighting, gaming desk, esports environment, tech lifestyle' }
                ]},
                electronics: { name: 'Electronics', scenarios: [
                    { name: 'Modern Desk', prompt: 'Device placed on a clean modern desk setup, minimalist workspace, natural lighting, professional office environment, productivity lifestyle' },
                    { name: 'Cafe Workspace', prompt: 'Device being used in a trendy coffee shop, remote work setup, casual work environment, modern cafe interior, digital nomad lifestyle' }
                ]},
                fashion: { name: 'Fashion/Accessories', scenarios: [
                    { name: 'Fashion Portrait', prompt: 'Person wearing/using the item in a fashion photoshoot, professional styling, fashion photography, elegant lifestyle' },
                    { name: 'Daily Routine', prompt: 'Person using the item in their daily routine, natural lifestyle, everyday moments, authentic usage' }
                ]},
                home: { name: 'Home/Kitchen', scenarios: [
                    { name: 'Morning Routine', prompt: 'Product being used in a bright modern kitchen during morning routine, natural lighting, home lifestyle, cozy atmosphere' },
                    { name: 'Living Room', prompt: 'Product in a stylish modern living room, home decor setup, comfortable home environment, lifestyle photography' }
                ]}
            };

            const productVariants = [
                { name: 'Classic Black', prompt: 'Transform the product to elegant matte black color scheme, sophisticated dark finish, premium black coating, luxurious black texture, maintaining all original design features and proportions' },
                { name: 'Pure White', prompt: 'Transform the product to clean pure white color, pristine white finish, minimalist white aesthetic, crisp white coating, modern white design while keeping original shape and details' },
                { name: 'Metallic Silver', prompt: 'Transform the product to brushed metallic silver finish, chrome-like surface, reflective silver coating, industrial metallic texture, premium metal appearance with original form' },
                { name: 'Rose Gold', prompt: 'Transform the product to elegant rose gold finish, warm pink-gold metallic surface, luxury rose gold coating, premium blush metal texture, sophisticated rose gold aesthetic' },
                { name: 'Ocean Blue', prompt: 'Transform the product to deep ocean blue color, rich navy blue finish, vibrant blue coating, professional blue aesthetic, maintaining original design with blue color theme' },
                { name: 'Forest Green', prompt: 'Transform the product to forest green color scheme, natural green finish, deep emerald green coating, earthy green aesthetic, eco-friendly green appearance with original structure' }
            ];

            // Generate color variants
            const generateColorVariants = async () => {
                if (!uploadedImage) {
                    alert('Please upload an image first');
                    return;
                }

                setIsGeneratingVariants(true);
                setIsProcessing(true);
                setProcessingText('Generating color variants...');
                setProgress(0);
                
                try {
                    const variants = [];
                    for (let i = 0; i < productVariants.length; i++) {
                        const variant = productVariants[i];
                        setProcessingText(`Generating ${variant.name}...`);
                        setProgress((i / productVariants.length) * 100);

                        const imageBase64 = uploadedImage.split(',')[1] || uploadedImage;
                        const response = await fetch('/api/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image_base64: imageBase64,
                                prompt: `${variant.prompt}. Professional product photography, clean white background, studio lighting, high-quality commercial shot.`,
                                guidance_scale: 7.0,
                                num_inference_steps: 25,
                                width: 1024,
                                height: 1024
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            variants.push({
                                id: i,
                                name: variant.name,
                                image: `data:image/png;base64,${result.image}`,
                                prompt: variant.prompt
                            });
                        }
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    setColorVariants(variants);
                    setViewMode('variants');
                    setProgress(100);
                    setProcessingText('Color variants generated!');
                    
                } catch (error) {
                    console.error('Error generating variants:', error);
                    alert('Failed to generate color variants');
                } finally {
                    setTimeout(() => {
                        setIsGeneratingVariants(false);
                        setIsProcessing(false);
                        setProgress(0);
                    }, 1500);
                }
            };

            // Generate lifestyle scenarios
            const generateLifestyleScenarios = async () => {
                if (selectedVariants.length === 0 && !uploadedImage) {
                    alert('Please select color variants or upload an image first');
                    return;
                }

                setIsGeneratingScenarios(true);
                setIsProcessing(true);
                setProcessingText('Generating lifestyle scenarios...');
                setProgress(0);

                try {
                    const scenarios = productCategories[selectedCategory]?.scenarios || productCategories.electronics.scenarios;
                    const allScenarios = [];
                    
                    const imagesToProcess = selectedVariants.length > 0 
                        ? colorVariants.filter(v => selectedVariants.includes(v.id))
                        : [{ name: 'Original', image: uploadedImage, id: 'original' }];

                    const totalSteps = imagesToProcess.length * scenarios.length;
                    let currentStep = 0;

                    for (const variant of imagesToProcess) {
                        for (const scenario of scenarios) {
                            setProcessingText(`${scenario.name} for ${variant.name}...`);
                            setProgress((currentStep / totalSteps) * 100);

                            const imageBase64 = variant.image.includes('data:image') ? variant.image.split(',')[1] : variant.image;
                            const response = await fetch('/api/generate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    image_base64: imageBase64,
                                    prompt: `${scenario.prompt}. Photorealistic lifestyle photography, natural lighting, high quality commercial photography, real-world usage scenario.`,
                                    guidance_scale: 6.5,
                                    num_inference_steps: 25,
                                    width: 1024,
                                    height: 1024
                                })
                            });

                            const result = await response.json();
                            if (result.success) {
                                allScenarios.push({
                                    id: `${variant.name}-${scenario.name}`,
                                    variantName: variant.name,
                                    variantImage: variant.image,
                                    scenarioName: scenario.name,
                                    image: `data:image/png;base64,${result.image}`
                                });
                            }

                            currentStep++;
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }

                    setLifestyleScenarios(allScenarios);
                    setViewMode('scenarios');
                    setProgress(100);
                    setProcessingText('Lifestyle scenarios generated!');
                    
                } catch (error) {
                    console.error('Error generating scenarios:', error);
                    alert('Failed to generate lifestyle scenarios');
                } finally {
                    setTimeout(() => {
                        setIsGeneratingScenarios(false);
                        setIsProcessing(false);
                        setProgress(0);
                    }, 1500);
                }
            };

            // AI Edit function for persistent prompt box below canvas
            const handleAIEdit = async (promptText) => {
                if (!uploadedImage) {
                    alert('Please upload an image first');
                    return;
                }

                if (!promptText || !promptText.trim()) {
                    alert('Please enter editing instructions');
                    return;
                }

                setIsProcessing(true);
                setProcessingText('AI is editing your image...');
                setProgress(0);

                const interval = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 90) {
                            clearInterval(interval);
                            return 90;
                        }
                        return prev + 5;
                    });
                }, 300);

                try {
                    const imageBase64 = uploadedImage.split(',')[1] || uploadedImage;
                    const guidanceScale = document.getElementById('ai-guidance-scale')?.value || 7.5;
                    const steps = document.getElementById('ai-quality')?.value || 28;
                    
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_base64: imageBase64,
                            prompt: promptText.trim(),
                            guidance_scale: parseFloat(guidanceScale),
                            num_inference_steps: parseInt(steps)
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        setProgress(100);
                        setTimeout(() => {
                            setUploadedImage('data:image/png;base64,' + result.image);
                            setIsProcessing(false);
                            setProgress(0);
                        }, 500);
                    } else {
                        setIsProcessing(false);
                        setProgress(0);
                        alert('Error: ' + (result.message || result.detail || 'Failed to edit image'));
                    }
                } catch (error) {
                    setIsProcessing(false);
                    setProgress(0);
                    alert('Error editing image: ' + error.message);
                }
            };

            // Store handleAIEdit function globally for the canvas prompt box
            React.useEffect(() => {
                window.handleAIEdit = handleAIEdit;
            }, [uploadedImage, setUploadedImage, setIsProcessing, setProcessingText, setProgress]);
            
            // Auto-collapse when image is uploaded, or manual collapse
            const isCollapsed = (uploadedImage && !sidebarCollapsed) || sidebarCollapsed;

            // Initialize main canvas when Basic Edits is active
            useEffect(() => {
                if (activeToolId === 'basic' && mainCanvasRef.current && !fabricCanvas) {
                    // Calculate available space dynamically
                    const mainContentEl = mainCanvasRef.current.closest('.flex-1');
                    const rect = mainContentEl ? mainContentEl.getBoundingClientRect() : { width: 800, height: 600 };
                    
                    // Larger canvas when sidebar is collapsed
                    const maxWidth = isCollapsed ? 1000 : 800;
                    const maxHeight = isCollapsed ? 700 : 600;
                    
                    const canvasWidth = Math.min(maxWidth, rect.width - 100); // subtract padding
                    const canvasHeight = Math.min(maxHeight, rect.height - 200); // subtract header/controls
                    
                    const canvas = new fabric.Canvas(mainCanvasRef.current, {
                        width: canvasWidth,
                        height: canvasHeight,
                        backgroundColor: 'white'
                    });
                    setFabricCanvas(canvas);
                    
                    // Load uploaded image if available
                    if (uploadedImage) {
                        fabric.Image.fromURL(uploadedImage, (img) => {
                            const scale = Math.min(canvasWidth / img.width, canvasHeight / img.height);
                            img.scale(scale);
                            img.set({
                                left: (canvasWidth - img.width * scale) / 2,
                                top: (canvasHeight - img.height * scale) / 2,
                                selectable: false
                            });
                            canvas.add(img);
                            canvas.sendToBack(img);
                            canvas.renderAll();
                        });
                    }
                } else if (activeToolId !== 'basic' && fabricCanvas) {
                    fabricCanvas.dispose();
                    setFabricCanvas(null);
                }
            }, [activeToolId, uploadedImage, fabricCanvas, setFabricCanvas, isCollapsed]);

            // Clean up canvas on unmount
            useEffect(() => {
                return () => {
                    if (fabricCanvas) {
                        fabricCanvas.dispose();
                        setFabricCanvas(null);
                    }
                };
            }, [fabricCanvas]);

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            };

            const handleFileUpload = (file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setUploadedImage(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleGenerate = async () => {
                if (!prompt.trim()) {
                    alert('Please enter a description for your image');
                    return;
                }

                setIsProcessing(true);
                setProcessingText('AI is generating your image...');
                setProgress(0);

                const interval = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 90) {
                            clearInterval(interval);
                            return 90;
                        }
                        return prev + 10;
                    });
                }, 500);

                try {
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt,
                            guidance_scale: 7.5,
                            num_inference_steps: 28,
                            width: 1024,
                            height: 1024
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        setProgress(100);
                        setTimeout(() => {
                            setUploadedImage('data:image/png;base64,' + result.image);
                            setIsProcessing(false);
                            setProgress(0);
                        }, 500);
                    } else {
                        setIsProcessing(false);
                        setProgress(0);
                        alert('Error: ' + (result.message || result.detail || 'Failed to generate image'));
                    }
                } catch (error) {
                    setIsProcessing(false);
                    setProgress(0);
                    alert('Error generating image: ' + error.message);
                }
            };


            const sampleImages = [
                'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=150&h=150&fit=crop',
                'https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=150&h=150&fit=crop',
                'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=150&h=150&fit=crop',
            ];

            return (
                <div className="flex h-full w-full bg-gray-900">
                    {/* Image Modal */}
                    {modalImage && (
                        <div 
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                zIndex: 10000,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '20px'
                            }}
                            onClick={() => setModalImage(null)}
                        >
                            <div style={{ position: 'relative', maxWidth: '90vw', maxHeight: '90vh' }}>
                                <img 
                                    src={modalImage} 
                                    style={{ 
                                        maxWidth: '100%', 
                                        maxHeight: '100%', 
                                        borderRadius: '12px',
                                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                                    }} 
                                />
                                <button
                                    onClick={() => setModalImage(null)}
                                    style={{
                                        position: 'absolute',
                                        top: '-10px',
                                        right: '-10px',
                                        width: '40px',
                                        height: '40px',
                                        borderRadius: '50%',
                                        backgroundColor: '#1f2937',
                                        color: 'white',
                                        border: 'none',
                                        fontSize: '20px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Main Content Area */}
                    {/* Left Column: Generation - Collapsible */}
                    <div className={`${isCollapsed ? 'w-12' : 'w-80'} bg-gray-800 border-r border-gray-700 overflow-y-auto flex-shrink-0 transition-all duration-300 ease-in-out`}>
                        {isCollapsed ? (
                            // Collapsed state - toggle buttons
                            <div className="p-3 flex flex-col items-center gap-3">
                                <button
                                    onClick={() => setSidebarCollapsed(false)}
                                    className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-gray-300 hover:text-white transition-colors"
                                    title="Show Generation Panel"
                                >
                                    <Icons.ChevronDown style={{ width: '16px', height: '16px', transform: 'rotate(-90deg)' }} />
                                </button>
                                {uploadedImage && (
                                    <button
                                        onClick={() => setUploadedImage(null)}
                                        className="w-8 h-8 bg-red-600 hover:bg-red-500 rounded-lg flex items-center justify-center text-white transition-colors"
                                        title="Clear Image"
                                    >
                                        <Icons.X style={{ width: '16px', height: '16px' }} />
                                    </button>
                                )}
                            </div>
                        ) : (
                            // Expanded state - full generation panel
                            <div className="p-6">
                                <div className="flex items-center justify-between mb-6">
                                    <h2 className="text-xl font-bold text-white">Generation</h2>
                                    <button
                                        onClick={() => setSidebarCollapsed(true)}
                                        className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-gray-300 hover:text-white transition-colors"
                                        title="Collapse Panel"
                                    >
                                        <Icons.ChevronDown style={{ width: '16px', height: '16px', transform: 'rotate(90deg)' }} />
                                    </button>
                                </div>
                        
                        {/* AI Prompt */}
                        <div className="mb-6">
                            <h3 className="text-sm font-semibold text-gray-300 mb-3">AI Prompt</h3>
                            <textarea
                                value={prompt}
                                onChange={(e) => setPrompt(e.target.value)}
                                placeholder="Describe your product..."
                                className="w-full h-24 px-3 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white placeholder-gray-400 resize-none focus:ring-2 focus:ring-primary focus:border-primary"
                                rows={3}
                            />
                        </div>

                        {/* Advanced Settings & Style Presets */}
                        <div className="mb-6 space-y-3">
                            <button
                                onClick={() => setShowAdvanced(!showAdvanced)}
                                className="flex items-center text-sm text-gray-400 hover:text-white"
                            >
                                Advanced Settings
                                <Icons.ChevronDown 
                                    style={{ 
                                        width: '16px', 
                                        height: '16px', 
                                        marginLeft: '4px',
                                        transform: showAdvanced ? 'rotate(180deg)' : 'rotate(0deg)',
                                        transition: 'transform 0.2s ease'
                                    }} 
                                />
                            </button>
                            
                            {showAdvanced && (
                                <div className="space-y-3 pl-4 border-l-2 border-gray-600">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-300 mb-1">
                                            Quality
                                        </label>
                                        <select className="w-full text-sm border border-gray-600 rounded-md bg-gray-700 text-white px-2 py-1">
                                            <option>Standard</option>
                                            <option>High</option>
                                            <option>Ultra</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-medium text-gray-300 mb-1">
                                            Style Preset
                                        </label>
                                        <select className="w-full text-sm border border-gray-600 rounded-md bg-gray-700 text-white px-2 py-1">
                                            <option>Photorealistic</option>
                                            <option>Artistic</option>
                                            <option>Minimalist</option>
                                            <option>Vintage</option>
                                        </select>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Generate Button */}
                        <button
                            onClick={handleGenerate}
                            disabled={!prompt.trim() || isProcessing}
                            className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white font-semibold py-3 px-4 rounded-lg transition-colors mb-4"
                        >
                            {isProcessing ? 'Generating...' : 'Generate'}
                        </button>

                        {/* Enhance & Refine Buttons */}
                        <div className="flex gap-2 mb-6">
                            <button className="flex-1 bg-gray-600 hover:bg-gray-500 text-gray-200 font-medium py-2 px-3 rounded-md text-sm transition-colors">
                                Enhance
                            </button>
                            <button className="flex-1 bg-gray-600 hover:bg-gray-500 text-gray-200 font-medium py-2 px-3 rounded-md text-sm transition-colors">
                                Refine
                            </button>
                        </div>

                        {/* Image Upload Section */}
                        <div>
                            <h3 className="text-sm font-semibold text-gray-300 mb-3">Image Upload</h3>
                            <div
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop}
                                onClick={() => fileInputRef.current?.click()}
                                className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${
                                    isDragOver 
                                        ? 'border-primary bg-primary/5' 
                                        : 'border-gray-600 hover:border-gray-500'
                                }`}
                            >
                                <Icons.Upload className="mx-auto h-12 w-12 text-gray-500 mb-3" />
                                <p className="text-sm text-gray-400 mb-1">
                                    Click to upload or drag and drop
                                </p>
                                <p className="text-xs text-gray-500">
                                    SVG, PNG, JPG or GIF (MAX. 800x400)
                                </p>
                            </div>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept="image/*"
                                    className="hidden"
                                    onChange={(e) => {
                                        if (e.target.files && e.target.files[0]) {
                                            handleFileUpload(e.target.files[0]);
                                        }
                                    }}
                                />
                            </div>
                        </div>
                        )}
                    </div>

                    {/* Right Column: Image Area */}
                    <div className="flex-1 bg-gray-900 flex flex-col min-w-0">
                        <div className="w-full flex items-center justify-center p-6" style={{
                            height: uploadedImage ? 'calc(100vh - 160px)' : 'calc(100vh - 80px)',
                            minHeight: '400px'
                        }}>
                            {activeToolId === 'basic' ? (
                                <div className="relative w-full h-full flex items-center justify-center">
                                    <canvas 
                                        ref={mainCanvasRef}
                                        style={{ 
                                            border: '2px solid #404040',
                                            borderRadius: '8px',
                                            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.3)'
                                        }}
                                    />
                                </div>
                            ) : uploadedImage ? (
                                <div className="relative w-full h-full flex items-center justify-center">
                                    <img
                                        src={uploadedImage}
                                        alt="Generated or uploaded"
                                        className="max-w-full max-h-full object-contain rounded-lg shadow-lg"
                                        style={{ maxHeight: 'calc(100vh - 200px)' }}
                                    />
                                    
                                    {/* Processing Overlay */}
                                    {isProcessing && (
                                        <div className="absolute inset-0 bg-black/70 flex flex-col items-center justify-center rounded-lg">
                                            <div className="w-16 h-16 border-4 border-gray-400 border-t-primary rounded-full animate-spin mb-4"></div>
                                            <p className="text-white font-semibold mb-2">{processingText}</p>
                                            <div className="w-48 h-2 bg-gray-600 rounded-full overflow-hidden">
                                                <div 
                                                    className="h-full bg-primary transition-all duration-300 ease-out"
                                                    style={{ width: `${progress}%` }}
                                                ></div>
                                            </div>
                                            <span className="text-white text-sm mt-2">{progress}%</span>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="w-full flex flex-col items-center justify-center text-center">
                                    <div className="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-gray-600">
                                        <Icons.Upload className="h-8 w-8 text-gray-500" />
                                    </div>
                                    <h3 className="text-lg font-medium text-gray-400 mb-2">
                                        No image loaded
                                    </h3>
                                    <p className="text-sm text-gray-500 max-w-md">
                                        Upload an image or generate one with AI to get started
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Floating AI Edit Prompt - Responsive to Sidebar */}
                        {uploadedImage && (
                            <div style={{
                                position: 'fixed',
                                bottom: '12px',
                                left: activeToolId ? '72px' : '0px',
                                right: activeToolId ? '360px' : '0px',
                                zIndex: 1000,
                                display: 'flex',
                                justifyContent: 'center',
                                paddingLeft: '24px',
                                paddingRight: '24px',
                                animation: 'slideUp 0.3s ease-out',
                                transition: 'left 0.3s ease, right 0.3s ease'
                            }}>
                                <div style={{
                                    width: '100%',
                                    maxWidth: activeToolId ? '600px' : '800px',
                                    transition: 'max-width 0.3s ease'
                                }}>
                                <div style={{
                                    background: 'rgba(26, 26, 26, 0.95)',
                                    backdropFilter: 'blur(20px)',
                                    border: '1px solid rgba(139, 92, 246, 0.3)',
                                    borderRadius: '12px',
                                    padding: '12px 16px',
                                    boxShadow: '0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(139, 92, 246, 0.1)',
                                    display: 'flex',
                                    gap: '16px',
                                    alignItems: 'center'
                                }}>
                                    <div style={{
                                        width: '32px',
                                        height: '32px',
                                        borderRadius: '8px',
                                        background: 'linear-gradient(135deg, #8b5cf6 0%, #14b8a6 100%)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        flexShrink: 0
                                    }}>
                                        <Icons.Wand2 style={{ width: '16px', height: '16px', color: 'white' }} />
                                    </div>
                                    
                                    <input
                                        id="persistent-ai-prompt"
                                        type="text"
                                        placeholder="Describe changes... (e.g., remove background, change to blue)"
                                        style={{
                                            flex: 1,
                                            background: 'transparent',
                                            border: 'none',
                                            outline: 'none',
                                            color: '#ffffff',
                                            fontSize: '16px',
                                            fontWeight: '400',
                                            fontFamily: 'inherit',
                                            '::placeholder': {
                                                color: '#888888'
                                            }
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                const prompt = e.target.value.trim();
                                                if (prompt && window.handleAIEdit) {
                                                    window.handleAIEdit(prompt);
                                                    e.target.value = '';
                                                }
                                            }
                                        }}
                                    />
                                    
                                    <button
                                        onClick={() => {
                                            const prompt = document.getElementById('persistent-ai-prompt').value.trim();
                                            if (prompt && window.handleAIEdit) {
                                                window.handleAIEdit(prompt);
                                                document.getElementById('persistent-ai-prompt').value = '';
                                            }
                                        }}
                                        style={{
                                            width: '32px',
                                            height: '32px',
                                            borderRadius: '8px',
                                            background: 'rgba(255, 255, 255, 0.1)',
                                            border: 'none',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            transition: 'all 0.2s ease',
                                            flexShrink: 0
                                        }}
                                        onMouseEnter={(e) => {
                                            e.target.style.background = 'rgba(255, 255, 255, 0.2)';
                                            e.target.style.transform = 'scale(1.05)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                                            e.target.style.transform = 'scale(1)';
                                        }}
                                    >
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ color: '#ffffff' }}>
                                            <path d="M5 12l5 5L20 7" />
                                        </svg>
                                    </button>
                                </div>
                                
                                {/* Add slide-up animation */}
                                <style dangerouslySetInnerHTML={{
                                    __html: `
                                        @keyframes slideUp {
                                            from {
                                                transform: translateX(-50%) translateY(100px);
                                                opacity: 0;
                                            }
                                            to {
                                                transform: translateX(-50%) translateY(0);
                                                opacity: 1;
                                            }
                                        }
                                        
                                        #persistent-ai-prompt::placeholder {
                                            color: #888888;
                                        }
                                    `
                                }} />
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        // Upload Panel Component with proper structure
        const UploadPanel = ({ uploadedImage, setUploadedImage }) => {
            const fileInputRef = useRef(null);
            const [isDragOver, setIsDragOver] = useState(false);

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            };

            const handleFileUpload = (file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setUploadedImage(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const sampleImages = [
                'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=150&h=150&fit=crop',
                'https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=150&h=150&fit=crop',
                'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=150&h=150&fit=crop',
            ];

            return !uploadedImage ? (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    {/* AI Generation Promotion */}
                    <div style={{
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        border: '1px solid rgba(139, 92, 246, 0.3)',
                        borderRadius: '16px',
                        padding: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        marginBottom: '24px'
                    }}>
                        <div style={{
                            width: '48px',
                            height: '48px',
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            borderRadius: '12px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                        }}>
                            <Icons.Wand2 style={{ width: '24px', height: '24px', color: '#8b5cf6' }} />
                        </div>
                        <div style={{ flex: 1 }}>
                            <h3 style={{
                                fontSize: '16px',
                                fontWeight: '600',
                                color: '#ffffff',
                                margin: '0 0 4px 0'
                            }}>Want to generate images with AI?</h3>
                            <p style={{
                                color: '#a3a3a3',
                                fontSize: '14px',
                                margin: '0 0 8px 0',
                                lineHeight: '1.4'
                            }}>Create stunning images from text descriptions using our AI tools.</p>
                            <button
                                onClick={() => {
                                    const aiTool = document.querySelector('[data-tool="ai"]');
                                    if (aiTool) aiTool.click();
                                }}
                                style={{
                                    padding: '6px 12px',
                                    background: 'linear-gradient(135deg, #8b5cf6 0%, #14b8a6 100%)',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'white',
                                    fontSize: '12px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px',
                                    transition: 'opacity 0.2s ease'
                                }}
                                onMouseEnter={(e) => e.target.style.opacity = '0.9'}
                                onMouseLeave={(e) => e.target.style.opacity = '1'}
                            >
                                <Icons.Wand2 style={{ width: '12px', height: '12px' }} />
                                Try AI Generation
                            </button>
                        </div>
                    </div>

                    {/* Enhanced Main Upload Section */}
                    <div style={{ flex: 1, minHeight: '600px', padding: '32px' }}>
                        <div 
                            className={`upload-zone ${isDragOver ? 'dragover' : ''}`}
                            style={{
                                height: '100%',
                                width: '100%',
                                borderRadius: '24px',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                justifyContent: 'center',
                                position: 'relative',
                                cursor: 'pointer',
                                transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                backgroundColor: isDragOver 
                                    ? 'rgba(20, 184, 166, 0.1)' 
                                    : 'rgba(45, 45, 45, 0.3)',
                                border: isDragOver 
                                    ? '3px solid #14b8a6' 
                                    : '3px dashed #404040',
                                boxShadow: isDragOver 
                                    ? '0 0 30px rgba(20, 184, 166, 0.3), inset 0 0 20px rgba(20, 184, 166, 0.05)' 
                                    : 'inset 0 1px 0 rgba(255, 255, 255, 0.1)',
                                transform: isDragOver ? 'scale(1.02)' : 'scale(1)',
                                backdropFilter: 'blur(10px)'
                            }}
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={handleDrop}
                            onClick={() => fileInputRef.current?.click()}
                        >
                            <div style={{ 
                                textAlign: 'center', 
                                position: 'relative',
                                zIndex: 2,
                                maxWidth: '600px'
                            }}>
                                {/* Animated Upload Icon */}
                                <div style={{
                                    width: '120px',
                                    height: '120px',
                                    margin: '0 auto 32px',
                                    background: isDragOver 
                                        ? 'linear-gradient(135deg, #14b8a6 0%, #059669 100%)'
                                        : 'linear-gradient(135deg, rgba(20, 184, 166, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%)',
                                    borderRadius: '50%',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                    transform: isDragOver ? 'scale(1.1) rotateZ(5deg)' : 'scale(1)',
                                    boxShadow: isDragOver 
                                        ? '0 20px 40px rgba(20, 184, 166, 0.4)' 
                                        : '0 8px 24px rgba(0, 0, 0, 0.15)',
                                    animation: isDragOver ? 'pulse 1s infinite' : 'float 6s ease-in-out infinite'
                                }}>
                                    <Icons.Upload style={{ 
                                        width: '48px', 
                                        height: '48px', 
                                        color: isDragOver ? '#ffffff' : '#14b8a6',
                                        transition: 'color 0.3s ease'
                                    }} />
                                </div>

                                {/* Main Heading */}
                                <h1 style={{ 
                                    fontSize: '32px', 
                                    fontWeight: '800', 
                                    marginBottom: '16px',
                                    color: '#ffffff',
                                    lineHeight: '1.2',
                                    transition: 'color 0.3s ease'
                                }}>
                                    {isDragOver ? 'Drop your image here!' : 'Start creating amazing edits'}
                                </h1>

                                {/* Subtitle */}
                                <p style={{ 
                                    color: isDragOver ? '#14b8a6' : '#a3a3a3',
                                    marginBottom: '40px',
                                    fontSize: '18px',
                                    lineHeight: '1.5',
                                    transition: 'color 0.3s ease',
                                    fontWeight: '500'
                                }}>
                                    {isDragOver 
                                        ? 'Release to upload your image' 
                                        : 'Drag & drop your image or browse from your device'
                                    }
                                </p>

                                {/* Upload Button */}
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        fileInputRef.current?.click();
                                    }}
                                    style={{
                                        padding: '16px 40px',
                                        background: 'linear-gradient(135deg, #14b8a6 0%, #8b5cf6 100%)',
                                        border: 'none',
                                        borderRadius: '16px',
                                        color: 'white',
                                        fontSize: '18px',
                                        fontWeight: '700',
                                        cursor: 'pointer',
                                        marginBottom: '40px',
                                        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                        boxShadow: '0 8px 25px rgba(20, 184, 166, 0.3)',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px',
                                        margin: '0 auto 40px'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.transform = 'translateY(-2px)';
                                        e.target.style.boxShadow = '0 12px 30px rgba(20, 184, 166, 0.4)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.transform = 'translateY(0)';
                                        e.target.style.boxShadow = '0 8px 25px rgba(20, 184, 166, 0.3)';
                                    }}
                                >
                                    <Icons.Upload style={{ width: '20px', height: '20px' }} />
                                    Choose Image
                                </button>

                                {/* Sample Images */}
                                <div style={{ 
                                    display: 'flex', 
                                    gap: '20px', 
                                    justifyContent: 'center',
                                    flexWrap: 'wrap'
                                }}>
                                    {sampleImages.map((src, index) => (
                                        <img 
                                            key={index}
                                            src={src} 
                                            alt={'Sample ' + (index + 1)}
                                            style={{ 
                                                width: '80px', 
                                                height: '80px', 
                                                borderRadius: '12px', 
                                                objectFit: 'cover', 
                                                cursor: 'pointer',
                                                border: '3px solid transparent',
                                                transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                                                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)'
                                            }}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setUploadedImage(src);
                                            }}
                                            onMouseEnter={(e) => {
                                                e.target.style.borderColor = '#14b8a6';
                                                e.target.style.transform = 'translateY(-4px) scale(1.05)';
                                                e.target.style.boxShadow = '0 12px 24px rgba(20, 184, 166, 0.4)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.target.style.borderColor = 'transparent';
                                                e.target.style.transform = 'translateY(0) scale(1)';
                                                e.target.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
                                            }}
                                        />
                                    ))}
                                </div>
                            </div>

                            {/* Hidden File Input */}
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*"
                                style={{ display: 'none' }}
                                onChange={(e) => {
                                    if (e.target.files && e.target.files[0]) {
                                        handleFileUpload(e.target.files[0]);
                                    }
                                }}
                            />
                        </div>
                    </div>
                </div>
            ) : (
                <div style={{
                    width: '100%',
                    height: '100%',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backgroundColor: '#2d2d2d',
                    borderRadius: '16px',
                    position: 'relative',
                    overflow: 'hidden'
                }}>
                    <img 
                        src={uploadedImage} 
                        alt="Uploaded" 
                        style={{ 
                            maxHeight: '100%', 
                            maxWidth: '100%', 
                            objectFit: 'contain',
                            borderRadius: '8px'
                        }}
                    />
                </div>
            );
        };

        // Tool Panel Component - Smooth Slide Animation
        const ToolPanel = ({ toolId, onClose, uploadedImage, setUploadedImage, setIsProcessing, setProcessingText, setProgress, isClosing, fabricCanvas, colorVariants, setColorVariants }) => {
            const panels = {
                upload: <UploadPanel uploadedImage={uploadedImage} setUploadedImage={setUploadedImage} />,
                basic: <BasicEditsPanel uploadedImage={uploadedImage} setUploadedImage={setUploadedImage} setIsProcessing={setIsProcessing} setProcessingText={setProcessingText} setProgress={setProgress} fabricCanvas={fabricCanvas} />,
                ai: <AIEditsPanel uploadedImage={uploadedImage} setUploadedImage={setUploadedImage} setIsProcessing={setIsProcessing} setProcessingText={setProcessingText} setProgress={setProgress} />,
                shots: <GenerateShotsPanel uploadedImage={uploadedImage} setUploadedImage={setUploadedImage} setIsProcessing={setIsProcessing} setProcessingText={setProcessingText} setProgress={setProgress} colorVariants={colorVariants} setColorVariants={setColorVariants} />,
                lifestyle: <LifestyleMockupsPanel uploadedImage={uploadedImage} setUploadedImage={setUploadedImage} setIsProcessing={setIsProcessing} setProcessingText={setProcessingText} setProgress={setProgress} colorVariants={colorVariants} />,
                animation: <AnimationPanel />,
                '3d': <ThreeDMockupsPanel />,
            };

            const titles = {
                upload: 'Upload & Import',
                basic: 'Basic Edits',
                ai: 'AI Edits',
                shots: 'Color Variants',
                lifestyle: 'Lifestyle Mockups',
                animation: 'Animation',
                '3d': '3D Mockups'
            };

            return (
                <div 
                    className={`tool-panel ${isClosing ? 'closing' : ''}`}
                    style={{
                        width: '360px',
                        backgroundColor: '#2d2d2d',
                        borderLeft: '1px solid #404040',
                        padding: '24px',
                        overflowY: 'auto',
                        height: '100vh'
                    }}
                >
                    <div style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        justifyContent: 'space-between', 
                        marginBottom: '24px' 
                    }}>
                        <h3 style={{ 
                            fontSize: '18px', 
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: 0
                        }}>
                            {titles[toolId]}
                        </h3>
                        <button 
                            onClick={onClose}
                            style={{
                                width: '32px',
                                height: '32px',
                                borderRadius: '8px',
                                backgroundColor: '#1a1a1a',
                                border: 'none',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                cursor: 'pointer',
                                color: '#a3a3a3'
                            }}
                            onMouseEnter={(e) => {
                                e.target.style.backgroundColor = '#374151';
                                e.target.style.color = '#ffffff';
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.backgroundColor = '#1a1a1a';
                                e.target.style.color = '#a3a3a3';
                            }}
                        >
                            <Icons.X style={{ width: '16px', height: '16px' }} />
                        </button>
                    </div>
                    {panels[toolId]}
                </div>
            );
        };


        // Basic Edits Panel with Fabric.js Canvas Editor
        const BasicEditsPanel = ({ uploadedImage, setUploadedImage, setIsProcessing, setProcessingText, setProgress, fabricCanvas }) => {
            const [activeTool, setActiveTool] = useState('select');
            const [brushColor, setBrushColor] = useState('#000000');
            const [brushWidth, setBrushWidth] = useState(5);

            // Tool functions
            const setSelectTool = () => {
                setActiveTool('select');
                if (fabricCanvas) {
                    fabricCanvas.isDrawingMode = false;
                    fabricCanvas.selection = true;
                    fabricCanvas.forEachObject(obj => obj.selectable = true);
                }
            };

            const setBrushTool = () => {
                setActiveTool('brush');
                if (fabricCanvas) {
                    fabricCanvas.isDrawingMode = true;
                    fabricCanvas.freeDrawingBrush.color = brushColor;
                    fabricCanvas.freeDrawingBrush.width = brushWidth;
                    fabricCanvas.selection = false;
                }
            };

            const setPenTool = () => {
                setActiveTool('pen');
                if (fabricCanvas) {
                    fabricCanvas.isDrawingMode = true;
                    fabricCanvas.freeDrawingBrush.color = brushColor;
                    fabricCanvas.freeDrawingBrush.width = 2;
                    fabricCanvas.selection = false;
                }
            };

            const setEraserTool = () => {
                setActiveTool('eraser');
                if (fabricCanvas) {
                    fabricCanvas.isDrawingMode = true;
                    fabricCanvas.freeDrawingBrush = new fabric.EraserBrush(fabricCanvas);
                    fabricCanvas.freeDrawingBrush.width = brushWidth;
                    fabricCanvas.selection = false;
                }
            };

            const addRectangle = () => {
                if (fabricCanvas) {
                    const rect = new fabric.Rect({
                        left: 100,
                        top: 100,
                        width: 100,
                        height: 100,
                        fill: 'transparent',
                        stroke: brushColor,
                        strokeWidth: 2
                    });
                    fabricCanvas.add(rect);
                    setActiveTool('select');
                    setSelectTool();
                }
            };

            const addCircle = () => {
                if (fabricCanvas) {
                    const circle = new fabric.Circle({
                        left: 100,
                        top: 100,
                        radius: 50,
                        fill: 'transparent',
                        stroke: brushColor,
                        strokeWidth: 2
                    });
                    fabricCanvas.add(circle);
                    setActiveTool('select');
                    setSelectTool();
                }
            };

            const addLine = () => {
                if (fabricCanvas) {
                    const line = new fabric.Line([50, 100, 200, 100], {
                        stroke: brushColor,
                        strokeWidth: 2
                    });
                    fabricCanvas.add(line);
                    setActiveTool('select');
                    setSelectTool();
                }
            };

            const addText = () => {
                if (fabricCanvas) {
                    const text = new fabric.IText('Double click to edit', {
                        left: 100,
                        top: 100,
                        fontSize: 20,
                        fill: brushColor
                    });
                    fabricCanvas.add(text);
                    setActiveTool('select');
                    setSelectTool();
                }
            };

            const deleteSelected = () => {
                if (fabricCanvas) {
                    const activeObjects = fabricCanvas.getActiveObjects();
                    fabricCanvas.remove(...activeObjects);
                    fabricCanvas.discardActiveObject();
                    fabricCanvas.renderAll();
                }
            };

            const clearCanvas = () => {
                if (fabricCanvas) {
                    fabricCanvas.clear();
                    fabricCanvas.backgroundColor = 'white';
                    fabricCanvas.renderAll();
                }
            };

            const saveCanvas = () => {
                if (fabricCanvas) {
                    const dataURL = fabricCanvas.toDataURL({
                        format: 'png',
                        quality: 1
                    });
                    setUploadedImage(dataURL);
                }
            };

            const applyFilter = (filterType) => {
                if (fabricCanvas) {
                    const activeObject = fabricCanvas.getActiveObject();
                    if (activeObject && activeObject.type === 'image') {
                        let filter;
                        switch (filterType) {
                            case 'blur':
                                filter = new fabric.Image.filters.Blur({ blur: 0.1 });
                                break;
                            case 'brightness':
                                filter = new fabric.Image.filters.Brightness({ brightness: 0.2 });
                                break;
                            case 'contrast':
                                filter = new fabric.Image.filters.Contrast({ contrast: 0.2 });
                                break;
                            case 'grayscale':
                                filter = new fabric.Image.filters.Grayscale();
                                break;
                            case 'sepia':
                                filter = new fabric.Image.filters.Sepia();
                                break;
                            case 'vintage':
                                filter = new fabric.Image.filters.Vintage();
                                break;
                            default:
                                return;
                        }
                        activeObject.filters.push(filter);
                        activeObject.applyFilters();
                        fabricCanvas.renderAll();
                    }
                }
            };

            const clearFilters = () => {
                if (fabricCanvas) {
                    const activeObject = fabricCanvas.getActiveObject();
                    if (activeObject && activeObject.type === 'image') {
                        activeObject.filters = [];
                        activeObject.applyFilters();
                        fabricCanvas.renderAll();
                    }
                }
            };

            const undoAction = () => {
                // Simple undo by removing last object
                if (fabricCanvas) {
                    const objects = fabricCanvas.getObjects();
                    if (objects.length > 0) {
                        fabricCanvas.remove(objects[objects.length - 1]);
                        fabricCanvas.renderAll();
                    }
                }
            };

            // Color presets
            const colorPresets = ['#000000', '#ffffff', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', height: '100%' }}>
                    {/* Drawing Tools */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '16px',
                        border: '1px solid #404040'
                    }}>
                        <h4 style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 12px 0'
                        }}>Drawing Tools</h4>
                        
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(4, 1fr)',
                            gap: '8px',
                            marginBottom: '16px'
                        }}>
                            {[
                                { id: 'select', icon: Icons.Search, action: setSelectTool },
                                { id: 'brush', icon: Icons.Brush, action: setBrushTool },
                                { id: 'pen', icon: Icons.Pen, action: setPenTool },
                                { id: 'eraser', icon: Icons.Eraser, action: setEraserTool }
                            ].map(tool => (
                                <button
                                    key={tool.id}
                                    onClick={tool.action}
                                    style={{
                                        padding: '8px',
                                        backgroundColor: activeTool === tool.id ? '#8b5cf6' : '#2d2d2d',
                                        border: '1px solid #404040',
                                        borderRadius: '6px',
                                        color: activeTool === tool.id ? '#ffffff' : '#a3a3a3',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    <tool.icon style={{ width: '16px', height: '16px' }} />
                                </button>
                            ))}
                        </div>

                        {/* Brush Settings */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            <label style={{ fontSize: '12px', color: '#a3a3a3' }}>Brush Size: {brushWidth}px</label>
                            <input
                                type="range"
                                min="1"
                                max="50"
                                value={brushWidth}
                                onChange={(e) => {
                                    setBrushWidth(parseInt(e.target.value));
                                    if (fabricCanvas && fabricCanvas.freeDrawingBrush) {
                                        fabricCanvas.freeDrawingBrush.width = parseInt(e.target.value);
                                    }
                                }}
                                style={{ width: '100%' }}
                            />
                        </div>
                    </div>

                    {/* Shape Tools */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '16px',
                        border: '1px solid #404040'
                    }}>
                        <h4 style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 12px 0'
                        }}>Shapes & Text</h4>
                        
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(2, 1fr)',
                            gap: '8px'
                        }}>
                            {[
                                { label: 'Rectangle', icon: Icons.Square, action: addRectangle },
                                { label: 'Circle', icon: Icons.Circle, action: addCircle },
                                { label: 'Line', icon: Icons.Minus, action: addLine },
                                { label: 'Text', icon: Icons.Type, action: addText }
                            ].map(tool => (
                                <button
                                    key={tool.label}
                                    onClick={tool.action}
                                    style={{
                                        padding: '8px 12px',
                                        backgroundColor: '#2d2d2d',
                                        border: '1px solid #404040',
                                        borderRadius: '6px',
                                        color: '#a3a3a3',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        fontSize: '12px'
                                    }}
                                >
                                    <tool.icon style={{ width: '14px', height: '14px' }} />
                                    {tool.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Color Picker */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '16px',
                        border: '1px solid #404040'
                    }}>
                        <h4 style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 12px 0'
                        }}>Colors</h4>
                        
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            <input
                                type="color"
                                value={brushColor}
                                onChange={(e) => setBrushColor(e.target.value)}
                                style={{
                                    width: '100%',
                                    height: '32px',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer'
                                }}
                            />
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(4, 1fr)',
                                gap: '6px'
                            }}>
                                {colorPresets.map(color => (
                                    <button
                                        key={color}
                                        onClick={() => setBrushColor(color)}
                                        style={{
                                            width: '24px',
                                            height: '24px',
                                            backgroundColor: color,
                                            border: brushColor === color ? '2px solid #8b5cf6' : '1px solid #404040',
                                            borderRadius: '4px',
                                            cursor: 'pointer'
                                        }}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Image Filters */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '16px',
                        border: '1px solid #404040'
                    }}>
                        <h4 style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 12px 0'
                        }}>Image Filters</h4>
                        
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(2, 1fr)',
                            gap: '8px',
                            marginBottom: '12px'
                        }}>
                            {[
                                { label: 'Blur', filter: 'blur' },
                                { label: 'Bright', filter: 'brightness' },
                                { label: 'Contrast', filter: 'contrast' },
                                { label: 'Grayscale', filter: 'grayscale' },
                                { label: 'Sepia', filter: 'sepia' },
                                { label: 'Vintage', filter: 'vintage' }
                            ].map(filter => (
                                <button
                                    key={filter.filter}
                                    onClick={() => applyFilter(filter.filter)}
                                    style={{
                                        padding: '6px 8px',
                                        backgroundColor: '#2d2d2d',
                                        border: '1px solid #404040',
                                        borderRadius: '6px',
                                        color: '#a3a3a3',
                                        cursor: 'pointer',
                                        fontSize: '11px'
                                    }}
                                >
                                    {filter.label}
                                </button>
                            ))}
                        </div>
                        
                        <button
                            onClick={clearFilters}
                            style={{
                                width: '100%',
                                padding: '6px',
                                backgroundColor: '#dc2626',
                                border: '1px solid #404040',
                                borderRadius: '6px',
                                color: '#ffffff',
                                cursor: 'pointer',
                                fontSize: '11px'
                            }}
                        >
                            Clear Filters
                        </button>
                    </div>

                    {/* Background Removal */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '16px',
                        border: '1px solid #404040'
                    }}>
                        <h4 style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 12px 0'
                        }}>Background Removal</h4>
                        
                        <button
                            onClick={async () => {
                                if (!uploadedImage) {
                                    alert('Please upload an image first');
                                    return;
                                }
                                
                                setIsProcessing(true);
                                setProcessingText('Removing background...');
                                setProgress(50);
                                
                                try {
                                    const response = await fetch('/api/remove-background', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            image_base64: uploadedImage.split(',')[1] || uploadedImage,
                                            operation: "remove_background"
                                        })
                                    });
                                    
                                    const result = await response.json();
                                    setProgress(100);
                                    
                                    if (result.success) {
                                        setUploadedImage(`data:image/png;base64,${result.image}`);
                                        setProcessingText(`Background removed using ${result.method} method`);
                                        setTimeout(() => setIsProcessing(false), 1000);
                                    } else {
                                        throw new Error(result.error);
                                    }
                                } catch (error) {
                                    alert(`Error removing background: ${error.message}`);
                                    setIsProcessing(false);
                                }
                            }}
                            disabled={!uploadedImage}
                            style={{
                                width: '100%',
                                padding: '12px',
                                backgroundColor: uploadedImage ? '#8b5cf6' : '#404040',
                                border: '1px solid #404040',
                                borderRadius: '8px',
                                color: uploadedImage ? '#ffffff' : '#666666',
                                cursor: uploadedImage ? 'pointer' : 'not-allowed',
                                fontSize: '14px',
                                fontWeight: '600',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => {
                                if (uploadedImage) {
                                    e.target.style.backgroundColor = '#7c3aed';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (uploadedImage) {
                                    e.target.style.backgroundColor = '#8b5cf6';
                                }
                            }}
                        >
                            <Icons.Crop style={{ width: '16px', height: '16px' }} />
                            Remove Background
                        </button>
                        
                        <p style={{
                            fontSize: '11px',
                            color: '#666666',
                            margin: '8px 0 0 0',
                            textAlign: 'center'
                        }}>
                            AI-powered background removal for professional results
                        </p>
                    </div>

                    {/* Action Buttons */}
                    <div style={{
                        display: 'flex',
                        gap: '8px',
                        flexWrap: 'wrap'
                    }}>
                        <button
                            onClick={undoAction}
                            style={{
                                flex: 1,
                                padding: '8px',
                                backgroundColor: '#2d2d2d',
                                border: '1px solid #404040',
                                borderRadius: '6px',
                                color: '#a3a3a3',
                                cursor: 'pointer',
                                fontSize: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                        >
                            <Icons.Undo style={{ width: '12px', height: '12px' }} />
                            Undo
                        </button>
                        <button
                            onClick={deleteSelected}
                            style={{
                                flex: 1,
                                padding: '8px',
                                backgroundColor: '#dc2626',
                                border: '1px solid #404040',
                                borderRadius: '6px',
                                color: '#ffffff',
                                cursor: 'pointer',
                                fontSize: '12px'
                            }}
                        >
                            Delete
                        </button>
                        <button
                            onClick={clearCanvas}
                            style={{
                                flex: 1,
                                padding: '8px',
                                backgroundColor: '#2d2d2d',
                                border: '1px solid #404040',
                                borderRadius: '6px',
                                color: '#a3a3a3',
                                cursor: 'pointer',
                                fontSize: '12px'
                            }}
                        >
                            Clear
                        </button>
                        <button
                            onClick={saveCanvas}
                            style={{
                                flex: 1,
                                padding: '8px',
                                backgroundColor: '#14b8a6',
                                border: '1px solid #404040',
                                borderRadius: '6px',
                                color: '#ffffff',
                                cursor: 'pointer',
                                fontSize: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                            }}
                        >
                            <Icons.Download style={{ width: '12px', height: '12px' }} />
                            Save
                        </button>
                    </div>
                </div>
            );
        };

        // AI Edits Panel - Simplified panel with info only
        const AIEditsPanel = ({ uploadedImage, setUploadedImage, setIsProcessing, setProcessingText, setProgress }) => {

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    {/* Info Section */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '20px',
                        border: '1px solid #404040'
                    }}>
                        <div style={{ marginBottom: '16px' }}>
                            <h4 style={{
                                fontSize: '16px',
                                fontWeight: '600',
                                color: '#ffffff',
                                margin: '0 0 8px 0',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                <Icons.Wand2 style={{ width: '18px', height: '18px', color: '#8b5cf6' }} />
                                AI Edit Mode
                            </h4>
                            <p style={{
                                color: '#a3a3a3',
                                fontSize: '14px',
                                margin: 0,
                                lineHeight: '1.5'
                            }}>
                                The AI edit prompt box is now permanently available below the canvas when you have an image uploaded. 
                                This makes it easier to iterate and make multiple edits to your image.
                            </p>
                        </div>

                        <div style={{
                            backgroundColor: '#2d2d2d',
                            borderRadius: '8px',
                            padding: '12px',
                            border: '1px solid #404040'
                        }}>
                            <h5 style={{
                                fontSize: '13px',
                                fontWeight: '600',
                                color: '#14b8a6',
                                margin: '0 0 8px 0'
                            }}>How to use AI editing:</h5>
                            <ul style={{
                                color: '#a3a3a3',
                                fontSize: '12px',
                                margin: 0,
                                paddingLeft: '16px',
                                lineHeight: '1.4'
                            }}>
                                <li>Upload or generate an image first</li>
                                <li>Look for the AI edit prompt box below the canvas</li>
                                <li>Type your editing instructions (e.g., "remove background", "change color to blue")</li>
                                <li>Press Enter or click the edit button to apply changes</li>
                            </ul>
                        </div>
                    </div>

                    {/* AI Settings */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '16px',
                        border: '1px solid #404040'
                    }}>
                        <h4 style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 12px 0'
                        }}>AI Settings</h4>
                        
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            <div>
                                <label style={{
                                    display: 'block',
                                    fontSize: '12px',
                                    color: '#a3a3a3',
                                    marginBottom: '4px'
                                }}>Guidance Scale</label>
                                <select id="ai-guidance-scale" style={{
                                    width: '100%',
                                    padding: '8px',
                                    backgroundColor: '#2d2d2d',
                                    border: '1px solid #404040',
                                    borderRadius: '6px',
                                    color: '#e5e5e5',
                                    fontSize: '12px'
                                }}>
                                    <option value="3.5">3.5 (More Creative)</option>
                                    <option value="7.5" selected>7.5 (Balanced)</option>
                                    <option value="10">10 (More Precise)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style={{
                                    display: 'block',
                                    fontSize: '12px',
                                    color: '#a3a3a3',
                                    marginBottom: '4px'
                                }}>Quality</label>
                                <select id="ai-quality" style={{
                                    width: '100%',
                                    padding: '8px',
                                    backgroundColor: '#2d2d2d',
                                    border: '1px solid #404040',
                                    borderRadius: '6px',
                                    color: '#e5e5e5',
                                    fontSize: '12px'
                                }}>
                                    <option value="15">Fast (15 steps)</option>
                                    <option value="28" selected>Balanced (28 steps)</option>
                                    <option value="50">High Quality (50 steps)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Color Variants Panel - Multiple Color Generation
        const GenerateShotsPanel = ({ uploadedImage, setUploadedImage, setIsProcessing, setProcessingText, setProgress, colorVariants, setColorVariants }) => {
            const [generatedShots, setGeneratedShots] = useState([]);
            const [selectedShot, setSelectedShot] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            const productVariants = [
                { 
                    name: 'Classic Black', 
                    prompt: 'Transform the product to elegant matte black color scheme, sophisticated dark finish, premium black coating, luxurious black texture, maintaining all original design features and proportions' 
                },
                { 
                    name: 'Pure White', 
                    prompt: 'Transform the product to clean pure white color, pristine white finish, minimalist white aesthetic, crisp white coating, modern white design while keeping original shape and details' 
                },
                { 
                    name: 'Metallic Silver', 
                    prompt: 'Transform the product to brushed metallic silver finish, chrome-like surface, reflective silver coating, industrial metallic texture, premium metal appearance with original form' 
                },
                { 
                    name: 'Rose Gold', 
                    prompt: 'Transform the product to elegant rose gold finish, warm pink-gold metallic surface, luxury rose gold coating, premium blush metal texture, sophisticated rose gold aesthetic' 
                },
                { 
                    name: 'Ocean Blue', 
                    prompt: 'Transform the product to deep ocean blue color, rich navy blue finish, vibrant blue coating, professional blue aesthetic, maintaining original design with blue color theme' 
                },
                { 
                    name: 'Forest Green', 
                    prompt: 'Transform the product to forest green color scheme, natural green finish, deep emerald green coating, earthy green aesthetic, eco-friendly green appearance with original structure' 
                }
            ];

            const generateShots = async () => {
                if (!uploadedImage) {
                    alert('Please upload a product image first');
                    return;
                }

                setIsGenerating(true);
                setIsProcessing(true);
                setProcessingText('Generating color variants...');
                setProgress(0);
                setGeneratedShots([]);

                try {
                    const shots = [];
                    const totalVariants = productVariants.length;

                    for (let i = 0; i < totalVariants; i++) {
                        const variant = productVariants[i];
                        setProcessingText(`Generating ${variant.name} variant...`);
                        setProgress((i / totalVariants) * 100);

                        const imageBase64 = uploadedImage.split(',')[1] || uploadedImage;
                        const uniquePrompt = `${variant.prompt}. Keep the exact same product design, shape, and proportions. Only change the color and finish as specified. Professional product photography, clean white background, studio lighting, high-quality commercial shot. Variant ${i + 1}: ${variant.name}`;
                        
                        const response = await fetch('/api/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image_base64: imageBase64,
                                prompt: uniquePrompt,
                                guidance_scale: 7.0,
                                num_inference_steps: 30,
                                width: 1024,
                                height: 1024
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            const variantData = {
                                id: i,
                                name: variant.name,
                                image: `data:image/png;base64,${result.image}`,
                                prompt: variant.prompt
                            };
                            shots.push(variantData);
                            setGeneratedShots([...shots]);
                            setColorVariants([...shots]); // Save to shared state
                        } else {
                            console.error(`Failed to generate ${variant.name}:`, result.error);
                        }

                        // Small delay between requests
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }

                    setProgress(100);
                    setProcessingText('Color variants generated successfully!');
                    
                } catch (error) {
                    console.error('Error generating variants:', error);
                    alert('Failed to generate variants. Please try again.');
                } finally {
                    setTimeout(() => {
                        setIsGenerating(false);
                        setIsProcessing(false);
                        setProgress(0);
                    }, 1500);
                }
            };

            const selectShot = (shot) => {
                setSelectedShot(shot);
                setUploadedImage(shot.image);
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '20px', height: '100%' }}>
                    {/* Header */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '20px',
                        border: '1px solid #404040'
                    }}>
                        <h4 style={{
                            fontSize: '16px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 8px 0',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px'
                        }}>
                            <Icons.Camera style={{ width: '18px', height: '18px', color: '#14b8a6' }} />
                            Generate Product Shots
                        </h4>
                        <p style={{
                            color: '#a3a3a3',
                            fontSize: '14px',
                            margin: 0,
                            lineHeight: '1.5'
                        }}>
                            Create multiple professional product shots from different angles using AI
                        </p>

                        <button
                            onClick={generateShots}
                            disabled={!uploadedImage || isGenerating}
                            style={{
                                width: '100%',
                                padding: '12px 16px',
                                marginTop: '16px',
                                background: uploadedImage && !isGenerating
                                    ? 'linear-gradient(135deg, #14b8a6 0%, #8b5cf6 100%)'
                                    : '#404040',
                                border: 'none',
                                borderRadius: '8px',
                                color: 'white',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: uploadedImage && !isGenerating ? 'pointer' : 'not-allowed',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                transition: 'all 0.2s ease'
                            }}
                        >
                            <Icons.Palette style={{ width: '16px', height: '16px' }} />
                            {isGenerating ? 'Generating...' : 'Generate Variants'}
                        </button>
                    </div>

                    {/* Generated Shots Grid */}
                    {generatedShots.length > 0 && (
                        <div style={{
                            backgroundColor: '#1a1a1a',
                            borderRadius: '12px',
                            padding: '20px',
                            border: '1px solid #404040',
                            flex: 1,
                            overflow: 'auto'
                        }}>
                            <h5 style={{
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#ffffff',
                                margin: '0 0 16px 0'
                            }}>Generated Shots ({generatedShots.length})</h5>

                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))',
                                gap: '12px'
                            }}>
                                {generatedShots.map((shot) => (
                                    <div
                                        key={shot.id}
                                        onClick={() => selectShot(shot)}
                                        style={{
                                            position: 'relative',
                                            borderRadius: '8px',
                                            overflow: 'hidden',
                                            cursor: 'pointer',
                                            border: selectedShot?.id === shot.id ? '2px solid #14b8a6' : '2px solid transparent',
                                            transition: 'all 0.2s ease'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (selectedShot?.id !== shot.id) {
                                                e.currentTarget.style.border = '2px solid #8b5cf6';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (selectedShot?.id !== shot.id) {
                                                e.currentTarget.style.border = '2px solid transparent';
                                            }
                                        }}
                                    >
                                        <img
                                            src={shot.image}
                                            alt={shot.name}
                                            style={{
                                                width: '100%',
                                                height: '120px',
                                                objectFit: 'cover',
                                                display: 'block'
                                            }}
                                        />
                                        <div style={{
                                            position: 'absolute',
                                            bottom: 0,
                                            left: 0,
                                            right: 0,
                                            background: 'linear-gradient(to top, rgba(0,0,0,0.8), transparent)',
                                            padding: '8px',
                                            color: 'white',
                                            fontSize: '11px',
                                            fontWeight: '500'
                                        }}>
                                            {shot.name}
                                        </div>
                                        {selectedShot?.id === shot.id && (
                                            <div style={{
                                                position: 'absolute',
                                                top: '8px',
                                                right: '8px',
                                                width: '20px',
                                                height: '20px',
                                                borderRadius: '50%',
                                                backgroundColor: '#14b8a6',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" style={{ color: 'white' }}>
                                                    <path d="M5 12l5 5L20 7" />
                                                </svg>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            {generatedShots.length > 0 && (
                                <p style={{
                                    fontSize: '11px',
                                    color: '#666666',
                                    margin: '12px 0 0 0',
                                    textAlign: 'center'
                                }}>
                                    Click on any shot to use it as your main image
                                </p>
                            )}
                        </div>
                    )}

                    {/* Shot Angles Preview */}
                    {generatedShots.length === 0 && !isGenerating && (
                        <div style={{
                            backgroundColor: '#1a1a1a',
                            borderRadius: '12px',
                            padding: '20px',
                            border: '1px solid #404040'
                        }}>
                            <h5 style={{
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#ffffff',
                                margin: '0 0 12px 0'
                            }}>Color Variants to Generate</h5>

                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                                gap: '8px'
                            }}>
                                {productVariants.map((variant, index) => (
                                    <div
                                        key={index}
                                        style={{
                                            padding: '8px',
                                            backgroundColor: '#2d2d2d',
                                            borderRadius: '6px',
                                            border: '1px solid #404040',
                                            textAlign: 'center'
                                        }}
                                    >
                                        <div style={{
                                            fontSize: '11px',
                                            fontWeight: '600',
                                            color: '#14b8a6',
                                            marginBottom: '4px'
                                        }}>
                                            {variant.name}
                                        </div>
                                        <div style={{
                                            fontSize: '10px',
                                            color: '#888888',
                                            lineHeight: '1.2'
                                        }}>
                                            {variant.prompt.split(',')[0]}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // Lifestyle Scenarios Panel - Realistic Use Case Generation
        const LifestyleMockupsPanel = ({ uploadedImage, setUploadedImage, setIsProcessing, setProcessingText, setProgress, colorVariants }) => {
            const [generatedScenarios, setGeneratedScenarios] = useState([]);
            const [selectedScenario, setSelectedScenario] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [detectedCategory, setDetectedCategory] = useState('electronics');
            const [selectedVariants, setSelectedVariants] = useState([]);
            const [selectAll, setSelectAll] = useState(false);

            // Product categories and their lifestyle scenarios
            const productCategories = {
                footwear: {
                    name: 'Footwear',
                    keywords: ['shoe', 'sneaker', 'boot', 'sandal', 'heel', 'footwear'],
                    scenarios: [
                        { name: 'Street Style', prompt: 'Person wearing the shoes walking on a modern city street, urban fashion photography, street style outfit, natural outdoor lighting, casual lifestyle' },
                        { name: 'Gym Workout', prompt: 'Athletic person wearing the shoes in a modern gym, fitness environment, workout session, sports photography, dynamic fitness lifestyle' },
                        { name: 'Coffee Shop', prompt: 'Person wearing the shoes sitting in a trendy coffee shop, casual lifestyle, modern cafe interior, relaxed atmosphere, lifestyle photography' },
                        { name: 'Park Walk', prompt: 'Person wearing the shoes walking in a beautiful park, outdoor lifestyle, natural environment, casual day out, lifestyle photography' }
                    ]
                },
                headphones: {
                    name: 'Audio/Headphones',
                    keywords: ['headphone', 'earbud', 'speaker', 'audio', 'wireless', 'bluetooth'],
                    scenarios: [
                        { name: 'Music Studio', prompt: 'Person wearing headphones in a professional music studio, music production setup, recording environment, creative workspace' },
                        { name: 'Coffee Shop Work', prompt: 'Person wearing headphones working on laptop in modern coffee shop, remote work lifestyle, productivity setup, casual work environment' },
                        { name: 'Gaming Setup', prompt: 'Person wearing headphones at a modern gaming setup, RGB lighting, gaming desk, esports environment, tech lifestyle' },
                        { name: 'Commute Travel', prompt: 'Person wearing headphones on public transport, commuter lifestyle, travel scene, urban transportation, daily routine' }
                    ]
                },
                electronics: {
                    name: 'Electronics',
                    keywords: ['phone', 'laptop', 'tablet', 'computer', 'device', 'tech', 'gadget', 'mouse', 'keyboard'],
                    scenarios: [
                        { name: 'Modern Desk', prompt: 'Device placed on a clean modern desk setup, minimalist workspace, natural lighting, professional office environment, productivity lifestyle' },
                        { name: 'Cafe Workspace', prompt: 'Device being used in a trendy coffee shop, remote work setup, casual work environment, modern cafe interior, digital nomad lifestyle' },
                        { name: 'Home Office', prompt: 'Device in a comfortable home office setup, cozy workspace, personal productivity space, work from home lifestyle' },
                        { name: 'Tech Showcase', prompt: 'Device displayed on a premium tech showcase table, studio lighting, product photography setup, luxury tech presentation' }
                    ]
                },
                fashion: {
                    name: 'Fashion/Accessories',
                    keywords: ['watch', 'bag', 'wallet', 'jewelry', 'sunglasses', 'hat', 'accessory', 'fashion'],
                    scenarios: [
                        { name: 'Fashion Portrait', prompt: 'Person wearing/using the item in a fashion photoshoot, professional styling, fashion photography, elegant lifestyle' },
                        { name: 'Daily Routine', prompt: 'Person using the item in their daily routine, natural lifestyle, everyday moments, authentic usage' },
                        { name: 'Business Meeting', prompt: 'Professional person using the item in a modern business setting, corporate environment, business lifestyle' },
                        { name: 'Social Event', prompt: 'Person with the item at a social gathering, party atmosphere, social lifestyle, evening event' }
                    ]
                },
                home: {
                    name: 'Home/Kitchen',
                    keywords: ['cup', 'mug', 'bottle', 'kitchen', 'home', 'decor', 'furniture', 'appliance'],
                    scenarios: [
                        { name: 'Morning Routine', prompt: 'Product being used in a bright modern kitchen during morning routine, natural lighting, home lifestyle, cozy atmosphere' },
                        { name: 'Dining Table', prompt: 'Product placed on a beautifully set dining table, home dining environment, family lifestyle, comfortable setting' },
                        { name: 'Living Room', prompt: 'Product in a stylish modern living room, home decor setup, comfortable home environment, lifestyle photography' },
                        { name: 'Outdoor Picnic', prompt: 'Product being used during an outdoor picnic, nature setting, outdoor lifestyle, casual outdoor dining' }
                    ]
                }
            };

            // Handle category selection
            const handleCategoryChange = (category) => {
                setDetectedCategory(category);
            };

            // Handle variant selection
            const toggleVariantSelection = (variantId) => {
                setSelectedVariants(prev => {
                    if (prev.includes(variantId)) {
                        return prev.filter(id => id !== variantId);
                    } else {
                        return [...prev, variantId];
                    }
                });
            };

            const toggleSelectAll = () => {
                if (selectAll) {
                    setSelectedVariants([]);
                    setSelectAll(false);
                } else {
                    setSelectedVariants(colorVariants.map(v => v.id));
                    setSelectAll(true);
                }
            };

            // Generate lifestyle scenarios for selected variants
            const generateScenariosForSelected = async () => {
                if (selectedVariants.length === 0 && !uploadedImage) {
                    alert('Please select color variants or upload an image first');
                    return;
                }

                setIsGenerating(true);
                setIsProcessing(true);
                setProgress(0);
                setGeneratedScenarios([]);

                try {
                    const scenarios = productCategories[detectedCategory]?.scenarios || productCategories.electronics.scenarios;
                    const allScenarios = [];
                    
                    // If no variants selected, use the main uploaded image
                    const imagesToProcess = selectedVariants.length > 0 
                        ? colorVariants.filter(v => selectedVariants.includes(v.id))
                        : [{ name: 'Original', image: uploadedImage, id: 'original' }];

                    const totalSteps = imagesToProcess.length * scenarios.length;
                    let currentStep = 0;

                    for (const variant of imagesToProcess) {
                        for (const scenario of scenarios) {
                            setProcessingText(`Generating ${scenario.name} for ${variant.name}...`);
                            setProgress((currentStep / totalSteps) * 100);

                            const imageBase64 = variant.image.includes('data:image') ? variant.image.split(',')[1] : variant.image;
                            const lifestylePrompt = `${scenario.prompt}. Photorealistic lifestyle photography, natural lighting, high quality commercial photography, real-world usage scenario. Include the ${variant.name.toLowerCase()} product naturally in the scene.`;
                            
                            const response = await fetch('/api/generate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    image_base64: imageBase64,
                                    prompt: lifestylePrompt,
                                    guidance_scale: 6.5,
                                    num_inference_steps: 25,
                                    width: 1024,
                                    height: 1024
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                allScenarios.push({
                                    id: `${variant.name}-${scenario.name}-${currentStep}`,
                                    variantName: variant.name,
                                    variantImage: variant.image,
                                    scenarioName: scenario.name,
                                    image: `data:image/png;base64,${result.image}`,
                                    prompt: scenario.prompt
                                });
                                setGeneratedScenarios([...allScenarios]);
                            }

                            currentStep++;
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }

                    setProgress(100);
                    setProcessingText('Lifestyle scenarios generated successfully!');
                    
                } catch (error) {
                    console.error('Error generating scenarios:', error);
                    alert('Failed to generate scenarios. Please try again.');
                } finally {
                    setTimeout(() => {
                        setIsGenerating(false);
                        setIsProcessing(false);
                        setProgress(0);
                    }, 1500);
                }
            };

            const selectScenario = (scenario) => {
                setSelectedScenario(scenario);
                setUploadedImage(scenario.image);
            };

            return (
                <div style={{ padding: '20px', color: '#e5e5e5' }}>
                    <h4 style={{ margin: '0 0 16px 0', fontSize: '16px', fontWeight: '600' }}>
                        Lifestyle Scenarios
                    </h4>
                    
                    <p style={{ margin: '0 0 20px 0', fontSize: '13px', color: '#a0a0a0', lineHeight: '1.4' }}>
                        Select color variants and generate realistic lifestyle scenarios showing your products in real-world usage contexts.
                    </p>

                    {/* Color Variants Selection */}
                    {colorVariants.length > 0 && (
                        <div style={{
                            backgroundColor: '#1a1a1a',
                            borderRadius: '12px',
                            padding: '16px',
                            marginBottom: '20px',
                            border: '1px solid #404040'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                <h5 style={{ fontSize: '14px', fontWeight: '600', color: '#ffffff', margin: 0 }}>
                                    Select Color Variants ({selectedVariants.length} selected)
                                </h5>
                                <button
                                    onClick={toggleSelectAll}
                                    style={{
                                        padding: '6px 12px',
                                        backgroundColor: selectAll ? '#14b8a6' : '#404040',
                                        color: selectAll ? '#000000' : '#ffffff',
                                        border: 'none',
                                        borderRadius: '6px',
                                        fontSize: '12px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    {selectAll ? 'Deselect All' : 'Select All'}
                                </button>
                            </div>

                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))',
                                gap: '12px'
                            }}>
                                {colorVariants.map((variant) => (
                                    <div
                                        key={variant.id}
                                        onClick={() => toggleVariantSelection(variant.id)}
                                        style={{
                                            position: 'relative',
                                            cursor: 'pointer',
                                            borderRadius: '8px',
                                            overflow: 'hidden',
                                            border: selectedVariants.includes(variant.id) ? '2px solid #14b8a6' : '1px solid #404040',
                                            transition: 'all 0.2s ease',
                                            backgroundColor: '#2d2d2d'
                                        }}
                                    >
                                        <img
                                            src={variant.image}
                                            alt={variant.name}
                                            style={{
                                                width: '100%',
                                                height: '80px',
                                                objectFit: 'cover',
                                                display: 'block'
                                            }}
                                        />
                                        <div style={{
                                            padding: '8px',
                                            fontSize: '11px',
                                            fontWeight: '500',
                                            color: '#ffffff',
                                            textAlign: 'center'
                                        }}>
                                            {variant.name}
                                        </div>
                                        {selectedVariants.includes(variant.id) && (
                                            <div style={{
                                                position: 'absolute',
                                                top: '6px',
                                                right: '6px',
                                                width: '18px',
                                                height: '18px',
                                                borderRadius: '50%',
                                                backgroundColor: '#14b8a6',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" style={{ color: 'white' }}>
                                                    <path d="M5 12l5 5L20 7" />
                                                </svg>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* No variants message */}
                    {colorVariants.length === 0 && (
                        <div style={{
                            backgroundColor: '#1a1a1a',
                            borderRadius: '8px',
                            padding: '16px',
                            marginBottom: '20px',
                            border: '1px solid #404040',
                            textAlign: 'center'
                        }}>
                            <p style={{ margin: 0, fontSize: '12px', color: '#a0a0a0' }}>
                                No color variants found. Go to "Color Variants" tab first to generate different colors, then return here to create lifestyle scenarios.
                            </p>
                        </div>
                    )}

                    {/* Category Selection */}
                    <div style={{
                        backgroundColor: '#1a1a1a',
                        borderRadius: '12px',
                        padding: '16px',
                        marginBottom: '20px',
                        border: '1px solid #404040'
                    }}>
                        <h5 style={{
                            fontSize: '14px',
                            fontWeight: '600',
                            color: '#ffffff',
                            margin: '0 0 12px 0'
                        }}>Product Category</h5>
                        
                        <p style={{ 
                            margin: '0 0 12px 0', 
                            fontSize: '12px', 
                            color: '#a0a0a0' 
                        }}>
                            Select your product category to get relevant lifestyle scenarios:
                        </p>

                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))',
                            gap: '8px'
                        }}>
                            {Object.entries(productCategories).map(([key, category]) => (
                                <button
                                    key={key}
                                    onClick={() => handleCategoryChange(key)}
                                    disabled={isGenerating}
                                    style={{
                                        padding: '10px 8px',
                                        backgroundColor: detectedCategory === key ? '#14b8a6' : '#404040',
                                        color: detectedCategory === key ? '#000000' : '#ffffff',
                                        border: 'none',
                                        borderRadius: '8px',
                                        fontSize: '11px',
                                        fontWeight: '600',
                                        cursor: isGenerating ? 'not-allowed' : 'pointer',
                                        transition: 'all 0.2s ease'
                                    }}
                                >
                                    {category.name}
                                </button>
                            ))}
                        </div>

                        {detectedCategory && (
                            <div style={{
                                marginTop: '12px',
                                padding: '8px',
                                backgroundColor: '#2d2d2d',
                                borderRadius: '6px',
                                fontSize: '11px',
                                color: '#14b8a6'
                            }}>
                                Selected: {productCategories[detectedCategory]?.name}
                            </div>
                        )}
                    </div>

                    {/* Generate Button */}
                    <div style={{ marginBottom: '20px' }}>
                        <button
                            onClick={generateScenariosForSelected}
                            disabled={(selectedVariants.length === 0 && !uploadedImage) || isGenerating}
                            style={{
                                width: '100%',
                                padding: '12px',
                                backgroundColor: isGenerating ? '#666666' : '#14b8a6',
                                color: isGenerating ? '#cccccc' : '#000000',
                                border: 'none',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: '600',
                                cursor: ((selectedVariants.length === 0 && !uploadedImage) || isGenerating) ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '8px',
                                transition: 'all 0.2s ease'
                            }}
                        >
                            <Icons.Users style={{ width: '16px', height: '16px' }} />
                            {isGenerating ? 'Generating...' : 
                                selectedVariants.length > 0 
                                    ? `Generate for ${selectedVariants.length} Variant${selectedVariants.length > 1 ? 's' : ''}` 
                                    : 'Generate Lifestyle Scenarios'}
                        </button>
                    </div>

                    {/* Generated Scenarios Grid */}
                    {generatedScenarios.length > 0 && (
                        <div style={{
                            backgroundColor: '#1a1a1a',
                            borderRadius: '12px',
                            padding: '16px',
                            border: '1px solid #404040'
                        }}>
                            <h5 style={{
                                fontSize: '14px',
                                fontWeight: '600',
                                color: '#ffffff',
                                margin: '0 0 12px 0'
                            }}>Generated Lifestyle Scenarios ({generatedScenarios.length})</h5>

                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))',
                                gap: '16px'
                            }}>
                                {generatedScenarios.map((scenario) => (
                                    <div
                                        key={scenario.id}
                                        onClick={() => selectScenario(scenario)}
                                        style={{
                                            position: 'relative',
                                            cursor: 'pointer',
                                            borderRadius: '12px',
                                            overflow: 'hidden',
                                            border: selectedScenario?.id === scenario.id ? '2px solid #14b8a6' : '1px solid #404040',
                                            transition: 'all 0.2s ease',
                                            backgroundColor: '#2d2d2d'
                                        }}
                                    >
                                        <img
                                            src={scenario.image}
                                            alt={`${scenario.variantName} - ${scenario.scenarioName}`}
                                            style={{
                                                width: '100%',
                                                height: '140px',
                                                objectFit: 'cover',
                                                display: 'block'
                                            }}
                                        />
                                        
                                        {/* Variant color indicator */}
                                        <div style={{
                                            position: 'absolute',
                                            top: '8px',
                                            left: '8px',
                                            backgroundColor: 'rgba(0,0,0,0.7)',
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '10px',
                                            color: '#14b8a6',
                                            fontWeight: '600'
                                        }}>
                                            {scenario.variantName}
                                        </div>

                                        {/* Scenario name */}
                                        <div style={{
                                            position: 'absolute',
                                            bottom: 0,
                                            left: 0,
                                            right: 0,
                                            background: 'linear-gradient(to top, rgba(0,0,0,0.9), transparent)',
                                            padding: '12px 8px 8px 8px',
                                            color: 'white'
                                        }}>
                                            <div style={{
                                                fontSize: '12px',
                                                fontWeight: '600',
                                                marginBottom: '2px'
                                            }}>
                                                {scenario.scenarioName}
                                            </div>
                                            <div style={{
                                                fontSize: '10px',
                                                color: '#cccccc',
                                                opacity: 0.8
                                            }}>
                                                Lifestyle Scene
                                            </div>
                                        </div>
                                        {selectedScenario?.id === scenario.id && (
                                            <div style={{
                                                position: 'absolute',
                                                top: '8px',
                                                right: '8px',
                                                width: '20px',
                                                height: '20px',
                                                borderRadius: '50%',
                                                backgroundColor: '#14b8a6',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center'
                                            }}>
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" style={{ color: 'white' }}>
                                                    <path d="M5 12l5 5L20 7" />
                                                </svg>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>

                            {generatedScenarios.length > 0 && (
                                <p style={{
                                    fontSize: '11px',
                                    color: '#666666',
                                    margin: '12px 0 0 0',
                                    textAlign: 'center'
                                }}>
                                    Click on any scenario to use it as your main image
                                </p>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        const AnimationPanel = () => <div style={{ color: '#e5e5e5' }}><p>Animation tools.</p></div>;
        const ThreeDMockupsPanel = () => <div style={{ color: '#e5e5e5' }}><p>3D mockups tools.</p></div>;

        // Render the app using React 18 createRoot
        const { createRoot } = ReactDOM;
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>